<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端庫存儀表板 (支援QR Code)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 QR Code 產生器 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* light blue-gray background (slate-50) */
            color: #1e293b; /* dark slate gray text (slate-900) */
        }
        /* ... (其餘樣式保持不變) ... */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .kpi-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            background-color: #ffffff; border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            border-radius: 0.75rem;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        input:focus, textarea:focus {
            outline: none !important;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.4) !important;
            border-color: #60a5fa !important;
        }
        .btn-primary { transition: background-color 0.2s ease-out, transform 0.1s ease-out; }
        .btn-primary:hover { transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        #qr-code-canvas {
            width: 256px !important; height: 256px !important;
            margin: 0 auto; border: 1px solid #e2e8f0; border-radius: 0.5rem;
        }
        /* 全局載入畫面 */
        #global-loader {
            position: fixed;
            inset: 0;
            background-color: rgba(248, 250, 252, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #e2e8f0;
            border-bottom-color: #3b82f6; /* Blue-500 */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Firebase 錯誤/提示訊息 */
        #firebase-error-banner {
            background-color: #ffedd5; /* orange-100 */
            color: #c2410c; /* orange-700 */
            border: 1px solid #fed7aa; /* orange-300 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem auto;
            max-width: 7xl;
            display: none; /* 預設隱藏 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- 全局載入畫面 (預設隱藏) -->
    <div id="global-loader" class="hidden">
        <div class="text-center">
            <div class="spinner"></div>
            <p id="loader-text" class="text-slate-600 mt-4">正在連接雲端資料庫...</p>
        </div>
    </div>

    <!-- Firebase 錯誤/提示訊息橫幅 -->
    <div id="firebase-error-banner">
        <h3 class="font-bold">提示</h3>
        <p>請點擊右上角的「⚙️ 設定」按鈕，貼上您的 Firebase 設定檔 (Config JSON) 以啟用雲端功能。</p>
    </div>

    <!-- 主要儀表板容器 (預設顯示) -->
    <div id="main-dashboard-container" class="max-w-7xl mx-auto">
        <!-- 頁面標題 --><header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-900">雲端庫存儀表板</h1>
                <p class="text-slate-600 mt-2">即時追蹤您的商品庫存狀態與出入庫動態。</p>
            </div>
            <!-- 新增設定按鈕 -->
            <button id="settings-btn" class="bg-slate-200 text-slate-700 p-3 rounded-full hover:bg-slate-300 transition-colors" title="設定 Firebase">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </header>

        <!-- 頂部統計卡片 --><section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- 總庫存量 --><div class="kpi-card p-6 flex items-center space-x-4">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-1v-1m0 1v1m0-1H8m4 0h4m-4 1v1m0-1H8m4 0h4m-4 1v1m0-1H8m4 0h4m1.93 12.07l-3-3-3 3-3-3-3 3-3-3 3-3 3 3 3-3 3 3z"/></svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">總庫存量</p>
                    <div id="total-stock" class="text-3xl font-bold text-slate-900">0</div>
                </div>
            </div>
            <!-- 庫存品項 --><div class="kpi-card p-6 flex items-center space-x-4">
                <div class="p-3 rounded-full bg-sky-100 text-sky-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">庫存品項</p>
                    <div id="total-items" class="text-3xl font-bold text-slate-900">0</div>
                </div>
            </div>
            <!-- 低庫存警示 --><div class="kpi-card p-6 flex items-center space-x-4">
                <div class="p-3 rounded-full bg-red-100 text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">低庫存警示</p>
                    <div id="low-stock-alerts" class="text-3xl font-bold text-red-600">0</div>
                </div>
            </div>
        </section>

        <!-- 新增商品表單 --><section class="bg-white p-6 rounded-xl shadow-sm mb-8 border border-slate-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4">新增商品資料</h2>
            <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <input type="text" id="add-name" placeholder="商品名稱" class="col-span-1 md:col-span-2 bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                <input type="text" id="add-category" placeholder="商品分類" class="col-span-1 md:col-span-1 bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                <input type="number" id="add-stock" placeholder="庫存量" class="col-span-1 md:col-span-1 bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                <input type="text" id="add-ponumber" placeholder="採購編號" class="col-span-1 md:col-span-1 bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                <input type="date" id="add-date" placeholder="入庫日期" class="col-span-1 md:col-span-1 bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                <textarea id="add-remarks" placeholder="備註 (選填)" class="col-span-1 md:col-span-6 bg-white text-slate-900 border border-slate-300 rounded-lg p-3" rows="2"></textarea>
                <button type="submit" class="col-span-1 md:col-span-6 bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors btn-primary">
                    新增商品
                </button>
            </form>
        </section>

        <main>
            <!-- 庫存列表格線 --><div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- 庫存項目卡片會由 JavaScript 動態插入到這裡 --></div>
        </main>

        <!-- 出庫紀錄區塊 --><section class="bg-white p-6 rounded-xl shadow-sm mt-8 border border-slate-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4">出庫紀錄</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">時間</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">商品名稱</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">採購編號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">出庫數量</th>
                        </tr>
                    </thead>
                    <tbody id="outbound-log-body" class="bg-white divide-y divide-slate-200">
                        <!-- 紀錄會由 JavaScript 動態插入到這裡 --></tbody>
                </table>
            </div>
        </section>

    </div> <!-- max-w-7xl end -->

    <!-- 快速出庫頁面容器 -->
    <div id="quick-outbound-container" class="hidden max-w-md mx-auto mt-10 p-6 bg-white rounded-xl shadow-lg border border-slate-200">
        <h2 class="text-2xl font-bold text-slate-900 text-center mb-4">快速出庫</h2>
        <div id="quick-outbound-loading" class="text-center text-slate-500">
            正在讀取商品資料...
        </div>
        <div id="quick-outbound-content" class="hidden space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-500">商品名稱</label>
                <p id="quick-outbound-name" class="text-xl font-semibold text-slate-900"></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-500">目前庫存</label>
                <p id="quick-outbound-stock" class="text-xl font-semibold text-slate-900"></p>
            </div>
            <button id="quick-outbound-button" class="w-full bg-blue-500 text-white font-bold py-4 px-4 rounded-lg hover:bg-blue-600 transition-colors btn-primary text-lg">
                確認出庫 (-1)
            </button>
            <div id="quick-outbound-message" class="text-center text-green-600 font-medium hidden"></div>
            <a href="inventory-dashboard.html" class="block text-center text-sm text-blue-600 hover:underline mt-4">返回主儀表板</a>
        </div>
    </div>


    <!-- 編輯商品 彈出視窗 (Modal) --><div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white modal-fade-in border-slate-200">
            <h3 class="text-2xl font-bold text-slate-900 mb-5">編輯商品</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-name" class="block text-sm font-medium text-slate-700">商品名稱</label>
                        <input type="text" id="edit-name" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                    </div>
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-slate-700">商品分類</label>
                        <input type="text" id="edit-category" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                    </div>
                    <div>
                        <label for="edit-stock" class="block text-sm font-medium text-slate-700">庫存量</label>
                        <input type="number" id="edit-stock" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                    </div>
                    <div>
                        <label for="edit-ponumber" class="block text-sm font-medium text-slate-700">採購編號</label>
                        <input type="text" id="edit-ponumber" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                    </div>
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-slate-700">入庫日期</label>
                        <input type="date" id="edit-date" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required>
                    </div>
                    <div>
                        <label for="edit-remarks" class="block text-sm font-medium text-slate-700">備註 (選填)</label>
                        <textarea id="edit-remarks" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3" rows="3"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-edit" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition-colors btn-primary">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors btn-primary">
                        儲存變更
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 出庫 彈出視窗 (Modal) --><div id="outbound-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white modal-fade-in border-slate-200">
            <h3 class="text-2xl font-bold text-slate-900 mb-5">商品出庫</h3>
            <form id="outbound-form">
                <input type="hidden" id="outbound-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">商品名稱</label>
                        <p id="outbound-name" class="text-lg font-semibold text-slate-900 mt-1"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">目前庫存</label>
                        <p id="outbound-current-stock" class="text-lg font-semibold text-slate-900 mt-1"></p>
                    </div>
                    <div>
                        <label for="outbound-quantity" class="block text-sm font-medium text-slate-700">出庫數量</label>
                        <input type="number" id="outbound-quantity" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3" required min="1">
                        <p id="outbound-error" class="text-red-600 text-sm mt-1 hidden"></p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-outbound" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition-colors btn-primary">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors btn-primary">
                        確認出庫
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- QR Code 產生 彈出視窗 (Modal) --><div id="qr-code-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-6 border w-full max-w-sm shadow-lg rounded-xl bg-white modal-fade-in border-slate-200">
            <h3 id="qr-code-title" class="text-xl font-bold text-slate-900 mb-4 text-center"></h3>
            <p class="text-center text-slate-600 text-sm mb-4">請掃描此 QR Code 進行快速出庫</p>
            <div id="qr-code-canvas-container"></div>
            <div class="mt-6 text-center">
                <button type="button" id="cancel-qr-code" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition-colors btn-primary">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- *** 新增：Firebase 設定彈出視窗 *** -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white modal-fade-in border-slate-200">
            <h3 class="text-2xl font-bold text-slate-900 mb-5">Firebase 設定</h3>
            <form id="settings-form">
                <div class="space-y-4">
                    <div>
                        <label for="firebase-config-input" class="block text-sm font-medium text-slate-700">Firebase 設定 (Config JSON)</label>
                        <p class="text-xs text-slate-500 mb-2">請從您的 Firebase 專案設定中，複製 'firebaseConfig' 物件的內容並貼於下方。</p>
                        <textarea id="firebase-config-input" class="mt-1 block w-full bg-white text-slate-900 border border-slate-300 rounded-lg p-3 font-mono text-sm" rows="10" placeholder="{
   apiKey: "AIzaSyD1Mo73znKs93FiyaXVCnKERAaWzSk_WFY",
            authDomain: "epson9000-9bcf2.firebaseapp.com",
            projectId: "epson9000-9bcf2",
            storageBucket: "epson9000-9bcf2.firebasestorage.app",
            messagingSenderId: "681687390935",
            appId: "1:681687390935:web:563c063abd00054fc06e92"
}"></textarea>
                        <p id="settings-error" class="text-red-600 text-sm mt-1 hidden"></p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-settings" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition-colors btn-primary">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors btn-primary">
                        儲存並重載
                    </button>
                </div>
            </form>
        </div>
    </div>


<!-- 
  *** Firebase 導入 ***
  我們將使用 Firebase v11.6.1 
-->
<script type="module">
    // 導入 Firebase 模組
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        addDoc, 
        setDoc, 
        updateDoc, 
        deleteDoc, 
        onSnapshot, 
        collection, 
        query, 
        serverTimestamp,
        Timestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 1. 初始化變數 ---
    
    // **移除：__app_id, __firebase_config, __initial_auth_token**
    
    let app, auth, db, userId;
    let inventoryCollectionRef, outboundLogCollectionRef;
    
    //  DOM 元素
    const globalLoader = document.getElementById('global-loader');
    const loaderText = document.getElementById('loader-text');
    const errorBanner = document.getElementById('firebase-error-banner');
    const mainDashboard = document.getElementById('main-dashboard-container');
    const quickOutboundContainer = document.getElementById('quick-outbound-container');
    
    // 設定 Modal DOM
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsForm = document.getElementById('settings-form');
    const cancelSettingsBtn = document.getElementById('cancel-settings');
    const configInput = document.getElementById('firebase-config-input');
    const settingsError = document.getElementById('settings-error');

    // App ID (我們仍然需要這個來隔離不同 App 的資料)
    // 這裡我們用一個固定的 App ID，或者也可以讓用戶輸入
    const appId = 'my-inventory-app-001'; // 給定一個固定的 ID
    
    // --- 2. 設定 Modal 邏輯 ---
    settingsBtn.addEventListener('click', () => {
        const configStr = localStorage.getItem('firebaseConfig');
        if (configStr) {
            configInput.value = JSON.stringify(JSON.parse(configStr), null, 4); // 格式化顯示
        }
        settingsModal.classList.remove('hidden');
    });

    cancelSettingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('hidden');
    });

    settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        settingsError.classList.add('hidden');
        let configJson;

        try {
            // 嘗試解析 JSON
            configJson = JSON.parse(configInput.value);
            
            // 簡單驗證
            if (!configJson.apiKey || !configJson.projectId || !configJson.authDomain) {
                throw new Error("設定檔中缺少 apiKey, projectId 或 authDomain。");
            }

            // 儲存到 localStorage
            localStorage.setItem('firebaseConfig', JSON.stringify(configJson));
            
            // 提示用戶重載
            alert("設定已儲存！頁面將重新載入以套用新設定。");
            location.reload();

        } catch (err) {
            settingsError.textContent = `儲存失敗: ${err.message}。請確認您貼上的是完整的 JSON。`;
            settingsError.classList.remove('hidden');
        }
    });


    // --- 3. 主程式 IIFE ---
    (async function main() {

        // 從 localStorage 讀取設定
        const configStr = localStorage.getItem('firebaseConfig');
        let firebaseConfig = null;

        if (configStr) {
            try {
                firebaseConfig = JSON.parse(configStr);
            } catch (e) {
                console.error("無法解析儲存的 Firebase 設定:", e);
                errorBanner.style.display = 'block';
                errorBanner.querySelector('p').textContent = '儲存的 Firebase 設定格式錯誤。請點擊「設定」重新輸入。';
            }
        }

        // 檢查 firebaseConfig 是否存在
        if (!firebaseConfig) {
            console.warn("找不到 Firebase 設定。");
            errorBanner.style.display = 'block'; // 顯示提示
            // 檢查是否為第一次使用，如果是，自動彈出設定
            if (!configStr) {
                settingsModal.classList.remove('hidden');
            }
            return; // 終止執行
        }

        // --- 4. 初始化 Firebase (如果設定存在) ---
        
        // 顯示載入器
        globalLoader.classList.remove('hidden');
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase 初始化失敗:", e);
            globalLoader.classList.add('hidden'); // 隱藏載入器
            errorBanner.style.display = 'block'; // 顯示錯誤訊息
            errorBanner.querySelector('p').textContent = `Firebase 初始化失敗: ${e.message}。請檢查您的設定檔。`;
            return; 
        }

        // --- 5. 檢查 URL 參數 (路由) ---
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');
        const itemId = params.get('id'); // ID 現在是字串

        // --- 6. 監聽認證狀態 (改用匿名登入) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Firebase 使用者已認證:", userId);
                
                // 設定 Firestore 集合路徑
                // **注意：我們使用 appId 和 userId 來建立唯一的路徑**
                inventoryCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/inventory`);
                outboundLogCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/outboundLog`);

                // 根據 URL 決定執行哪個功能
                if (action === 'quickOutbound' && itemId) {
                    // 執行快速出庫
                    loaderText.textContent = "正在載入商品...";
                    await initializeQuickOutbound(itemId);
                    globalLoader.classList.add('hidden'); // 隱藏載入器
                    quickOutboundContainer.classList.remove('hidden');
                    mainDashboard.classList.add('hidden'); // 隱藏主儀表板
                } else {
                    // 執行主儀表板
                    loaderText.textContent = "正在載入庫存資料...";
                    initializeDashboard();
                    // (onSnapshot 會處理隱藏 loader)
                }
            } else {
                // 嘗試匿名登入
                console.log("尚未認證，嘗試匿名登入...");
                loaderText.textContent = "正在驗證身份...";
                try {
                    await signInAnonymously(auth);
                    // 登入成功後，onAuthStateChanged 會再次觸發
                } catch (error) {
                    console.error("Firebase 匿名登入失敗:", error);
                    globalLoader.classList.add('hidden'); // 隱藏載入器
                    errorBanner.style.display = 'block';
                    errorBanner.querySelector('p').textContent = `Firebase 登入失敗: ${error.message}。請檢查您的網路和 Firebase 規則。`;
                }
            }
        });


        // --- 7. 快速出庫頁面邏輯 (Firestore 版本) ---
        async function initializeQuickOutbound(id) {
            const loadingEl = document.getElementById('quick-outbound-loading');
            const contentEl = document.getElementById('quick-outbound-content');
            const nameEl = document.getElementById('quick-outbound-name');
            const stockEl = document.getElementById('quick-outbound-stock');
            const buttonEl = document.getElementById('quick-outbound-button');
            const messageEl = document.getElementById('quick-outbound-message');

            if (!inventoryCollectionRef) {
                loadingEl.innerHTML = '<p class="text-red-600">資料庫尚未準備就緒，請稍候...</p>';
                return;
            }

            const itemRef = doc(db, inventoryCollectionRef.path, id);
            let itemDoc, item;

            try {
                itemDoc = await getDoc(itemRef);
                if (!itemDoc.exists()) {
                    throw new Error("找不到此商品！(ID: " + id + ")");
                }
                item = { id: itemDoc.id, ...itemDoc.data() };
            } catch (err) {
                console.error(err);
                nameEl.textContent = '錯誤';
                stockEl.textContent = err.message;
                buttonEl.disabled = true;
                buttonEl.classList.add('bg-gray-400', 'cursor-not-allowed');
                buttonEl.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                return;
            }

            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            nameEl.textContent = item.name;
            stockEl.textContent = item.stock;

            if (item.stock === 0) {
                buttonEl.textContent = '庫存為 0';
                buttonEl.disabled = true;
                buttonEl.classList.add('bg-red-400', 'cursor-not-allowed');
                buttonEl.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                return;
            }

            buttonEl.addEventListener('click', async () => {
                buttonEl.disabled = true;
                buttonEl.textContent = '處理中...';

                try {
                    const freshDoc = await getDoc(itemRef);
                    const freshItem = freshDoc.data();

                    if (freshItem.stock > 0) {
                        await updateDoc(itemRef, {
                            stock: freshItem.stock - 1
                        });

                        const logEntry = {
                            timestamp: serverTimestamp(),
                            name: freshItem.name,
                            poNumber: freshItem.poNumber,
                            quantity: 1,
                        };
                        await addDoc(outboundLogCollectionRef, logEntry);

                        stockEl.textContent = freshItem.stock - 1;
                        messageEl.textContent = `出庫成功！ ${freshItem.name} 剩餘庫存: ${freshItem.stock - 1}`;
                        messageEl.classList.remove('hidden');
                        buttonEl.textContent = '已出庫';
                        buttonEl.classList.add('bg-green-500', 'cursor-not-allowed');
                        buttonEl.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    } else {
                        stockEl.textContent = 0;
                        messageEl.textContent = '庫存已為 0，無法出庫。';
                        messageEl.classList.remove('hidden');
                        messageEl.classList.add('text-red-600');
                        messageEl.classList.remove('text-green-600');
                        buttonEl.textContent = '庫存為 0';
                        buttonEl.classList.add('bg-red-400', 'cursor-not-allowed');
                        buttonEl.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    }
                } catch (err) {
                    console.error("快速出庫失敗:", err);
                    messageEl.textContent = `出庫失敗: ${err.message}`;
                    messageEl.classList.remove('hidden');
                    messageEl.classList.add('text-red-600');
                    messageEl.classList.remove('text-green-600');
                    buttonEl.disabled = false; 
                    buttonEl.textContent = '確認出庫 (-1)';
                }
            });
        }


        // --- 8. 主儀表板邏輯 (Firestore 版本) ---
        function initializeDashboard() {
            const LOW_STOCK_THRESHOLD = 10;
            
            let inventoryData = []; // 本地快照
            let outboundLog = []; // 本地快照

            // DOM 元素
            const grid = document.getElementById('inventory-grid');
            const addForm = document.getElementById('add-product-form');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const outboundModal = document.getElementById('outbound-modal');
            const outboundForm = document.getElementById('outbound-form');
            const cancelOutboundBtn = document.getElementById('cancel-outbound');
            const outboundError = document.getElementById('outbound-error');
            const qrCodeModal = document.getElementById('qr-code-modal');
            const qrCodeTitle = document.getElementById('qr-code-title');
            const qrCodeContainer = document.getElementById('qr-code-canvas-container');
            const cancelQrCodeBtn = document.getElementById('cancel-qr-code');
            const totalStockEl = document.getElementById('total-stock');
            const totalItemsEl = document.getElementById('total-items');
            const lowStockAlertsEl = document.getElementById('low-stock-alerts');
            const logBody = document.getElementById('outbound-log-body');

            // --- 核心監聽器 ---
            if (!inventoryCollectionRef) {
                console.warn("儀表板初始化時，資料庫尚未準備就緒。");
                globalLoader.classList.add('hidden');
                grid.innerHTML = `<p class="text-red-500 col-span-full text-center">資料庫連線失敗，請設定 Firebase Config。</p>`;
                return;
            }

            // 1. 監聽庫存資料
            const qInventory = query(inventoryCollectionRef);
            onSnapshot(qInventory, (querySnapshot) => {
                inventoryData = []; 
                querySnapshot.forEach((doc) => {
                    inventoryData.push({ id: doc.id, ...doc.data() });
                });
                renderInventory(); 
                globalLoader.classList.add('hidden'); 
                mainDashboard.classList.remove('hidden');
            }, (error) => {
                console.error("讀取庫存失敗:", error);
                grid.innerHTML = `<p class="text-red-500 col-span-full text-center">讀取庫存失敗: ${error.message}</p>`;
                globalLoader.classList.add('hidden'); 
                mainDashboard.classList.remove('hidden');
            });

            // 2. 監聽出庫紀錄
            const qLog = query(outboundLogCollectionRef);
            onSnapshot(qLog, (querySnapshot) => {
                outboundLog = []; 
                querySnapshot.forEach((doc) => {
                    outboundLog.push({ id: doc.id, ...doc.data() });
                });
                renderOutboundLog(); 
            }, (error) => {
                console.error("讀取紀錄失敗:", error);
                logBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">讀取紀錄失敗: ${error.message}</td></tr>`;
            });


            // --- 渲染功能 (保持不變) ---

            // 1. 渲染所有商品卡片
            function renderInventory() {
                grid.innerHTML = '';
                
                if (inventoryData.length === 0) {
                    grid.innerHTML = '<p class="text-slate-500 col-span-full text-center">目前沒有庫存商品。</p>';
                    updateStatistics(); 
                    return;
                }

                inventoryData.forEach(item => {
                    const stockColorClass = item.stock < LOW_STOCK_THRESHOLD ? 'text-red-600' : 'text-slate-900';
                    const stockBgClass = item.stock < LOW_STOCK_THRESHOLD ? 'bg-red-100' : 'bg-slate-100';
                    const stockRingClass = item.stock < LOW_STOCK_THRESHOLD ? 'ring-red-300' : 'ring-transparent';

                    const card = document.createElement('div');
                    card.className = `bg-white rounded-xl shadow-sm overflow-hidden flex flex-col transition-shadow hover:shadow-lg ring-1 ${stockRingClass} border border-slate-200`;
                    
                    const remarksHtml = item.remarks ? `
                        <div class="mt-3 pt-3 border-t border-slate-100">
                            <p class="text-sm font-medium text-slate-500">備註：</p>
                            <p class="text-sm text-slate-700 whitespace-pre-wrap">${escapeHTML(item.remarks)}</p>
                        </div>
                    ` : '';

                    card.innerHTML = `
                        <div class="p-5 ${item.stock < LOW_STOCK_THRESHOLD ? 'bg-red-50' : ''} flex-grow">
                            <div class="flex justify-between items-start">
                                <span class="inline-block bg-sky-100 text-sky-800 text-xs font-semibold px-3 py-1 rounded-full mb-2">${escapeHTML(item.category)}</span>
                                <div class="relative ${stockBgClass} rounded-full px-4 py-2">
                                    <span class="absolute top-0 right-2 text-xs text-slate-400">庫存</span>
                                    <span class="text-3xl font-bold ${stockColorClass}">${item.stock}</span>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-slate-900 mt-2 truncate">${escapeHTML(item.name)}</h3>
                            <div class="mt-3 space-y-2 text-sm text-slate-600">
                                <p><strong>採購編號:</strong> ${escapeHTML(item.poNumber)}</p>
                                <p><strong>入庫日期:</strong> ${item.stockDate}</p>
                            </div>
                            ${remarksHtml}
                        </div>
                        <div class="bg-slate-50 p-4 flex justify-end space-x-2">
                            <button data-id="${item.id}" data-name="${escapeHTML(item.name)}" class="qr-btn bg-gray-600 text-white text-sm font-medium py-2 px-3 rounded-lg hover:bg-gray-700 transition-colors btn-primary" title="產生快速出庫 QR Code">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 5h1m-6.464 6.464l.707.707m-4.242 0l-.707.707M4 12H3m1-6l.707-.707m0 4.242l.707.707m0 4.243l-.707.707M12 20v-1m6-5h-1m-6.464-6.464l.707-.707M7.757 7.757l-.707-.707m0 4.242l-.707.707m0 4.243l.707.707" /></svg>
                            </button>
                            <button data-id="${item.id}" class="outbound-btn bg-blue-500 text-white text-sm font-medium py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors btn-primary">
                                出庫
                            </button>
                            <button data-id="${item.id}" class="edit-btn bg-blue-500 text-white text-sm font-medium py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors btn-primary">
                                編輯
                            </button>
                            <button data-id="${item.id}" class="delete-btn bg-red-500 text-white text-sm font-medium py-2 px-3 rounded-lg hover:bg-red-600 transition-colors btn-primary">
                                刪除
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                updateStatistics();
                bindEventListeners();
            }

            // 2. 更新頂部統計卡片
            function updateStatistics() {
                let totalStock = 0;
                let lowStockCount = 0;

                inventoryData.forEach(item => {
                    totalStock += item.stock;
                    if (item.stock < LOW_STOCK_THRESHOLD) {
                        lowStockCount++;
                    }
                });

                totalStockEl.textContent = totalStock;
                totalItemsEl.textContent = inventoryData.length;
                lowStockAlertsEl.textContent = lowStockCount;
            }

            // 3. 渲染出庫紀錄
            function renderOutboundLog() {
                logBody.innerHTML = ''; // 清空
                
                const sortedLog = [...outboundLog].sort((a, b) => {
                    const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return timeB - timeA; // 倒序
                });

                sortedLog.forEach(log => {
                    const row = document.createElement('tr');
                    let timestampStr = 'N/A';
                    if (log.timestamp) {
                        const date = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                        timestampStr = date.toLocaleString('zh-TW');
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${timestampStr}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 font-medium">${escapeHTML(log.name)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${escapeHTML(log.poNumber)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">-${log.quantity}</td>
                    `;
                    logBody.appendChild(row);
                });

                if (outboundLog.length === 0) {
                    logBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">目前沒有出庫紀錄。</td></tr>';
                }
            }

            // 4. 綁定所有卡片按鈕的事件
            function bindEventListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', handleEditClick);
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteClick);
                });
                document.querySelectorAll('.outbound-btn').forEach(btn => {
                    btn.addEventListener('click', handleOutboundClick);
                });
                document.querySelectorAll('.qr-btn').forEach(btn => {
                    btn.addEventListener('click', handleQrClick);
                });
            }

            // --- C.R.U.D. 功能 (Firestore 版本) ---

            // 5. 新增商品 (Create)
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;
                button.textContent = "新增中...";

                const newItem = {
                    name: document.getElementById('add-name').value,
                    category: document.getElementById('add-category').value,
                    stock: parseInt(document.getElementById('add-stock').value, 10),
                    poNumber: document.getElementById('add-ponumber').value,
                    stockDate: document.getElementById('add-date').value,
                    remarks: document.getElementById('add-remarks').value,
                    createdAt: serverTimestamp(), 
                };

                try {
                    await addDoc(inventoryCollectionRef, newItem);
                    addForm.reset(); 
                } catch (err) {
                    console.error("新增商品失敗:", err);
                    alert("新增失敗: " + err.message); 
                } finally {
                    button.disabled = false;
                    button.textContent = "新增商品";
                }
            });

            // 6. 點擊刪除 (Delete)
            async function handleDeleteClick(e) {
                const id = e.currentTarget.dataset.id;
                console.log(`正在刪除 ID: ${id}`);
                
                try {
                    await deleteDoc(doc(db, inventoryCollectionRef.path, id));
                } catch (err) {
                    console.error("刪除失敗:", err);
                    alert("刪除失敗: " + err.message);
                }
            }

            // 7. 編輯 (Update)
            function handleEditClick(e) {
                const id = e.currentTarget.dataset.id;
                const item = inventoryData.find(i => i.id === id); 
                
                document.getElementById('edit-id').value = item.id;
                document.getElementById('edit-name').value = item.name;
                document.getElementById('edit-category').value = item.category;
                document.getElementById('edit-stock').value = item.stock;
                document.getElementById('edit-ponumber').value = item.poNumber;
                document.getElementById('edit-date').value = item.stockDate;
                document.getElementById('edit-remarks').value = item.remarks;

                editModal.classList.remove('hidden');
            }

            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
            });

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;
                button.textContent = "儲存中...";

                const updatedData = {
                    name: document.getElementById('edit-name').value,
                    category: document.getElementById('edit-category').value,
                    stock: parseInt(document.getElementById('edit-stock').value, 10),
                    poNumber: document.getElementById('edit-ponumber').value,
                    stockDate: document.getElementById('edit-date').value,
                    remarks: document.getElementById('edit-remarks').value,
                };

                try {
                    await updateDoc(doc(db, inventoryCollectionRef.path, id), updatedData);
                    editModal.classList.add('hidden');
                } catch (err) {
                    console.error("更新失敗:", err);
                    alert("更新失敗: " + err.message);
                } finally {
                    button.disabled = false;
                    button.textContent = "儲存變更";
                }
            });

            // 8. 手動出庫 (Update + Create)
            function handleOutboundClick(e) {
                const id = e.currentTarget.dataset.id;
                const item = inventoryData.find(i => i.id === id);

                document.getElementById('outbound-id').value = item.id;
                document.getElementById('outbound-name').textContent = item.name;
                document.getElementById('outbound-current-stock').textContent = item.stock;
                document.getElementById('outbound-quantity').value = '1'; 
                document.getElementById('outbound-quantity').max = item.stock;
                outboundError.classList.add('hidden');

                outboundModal.classList.remove('hidden');
            }
            
            cancelOutboundBtn.addEventListener('click', () => {
                outboundModal.classList.add('hidden');
            });

            outboundForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('outbound-id').value;
                const quantity = parseInt(document.getElementById('outbound-quantity').value, 10);
                
                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;
                button.textContent = "出庫中...";
                
                const itemRef = doc(db, inventoryCollectionRef.path, id);
                const item = inventoryData.find(i => i.id === id); 

                if (quantity > item.stock) {
                    outboundError.textContent = '出庫數量不能超過目前庫存！';
                    outboundError.classList.remove('hidden');
                    button.disabled = false;
                    button.textContent = "確認出庫";
                    return;
                }
                if (quantity <= 0) {
                    outboundError.textContent = '出庫數量必須大於 0。';
                    outboundError.classList.remove('hidden');
                    button.disabled = false;
                    button.textContent = "確認出庫";
                    return;
                }

                try {
                    await updateDoc(itemRef, {
                        stock: item.stock - quantity
                    });

                    const logEntry = {
                        timestamp: serverTimestamp(),
                        name: item.name,
                        poNumber: item.poNumber,
                        quantity: quantity,
                    };
                    await addDoc(outboundLogCollectionRef, logEntry);

                    outboundModal.classList.add('hidden');

                } catch (err) {
                     console.error("手動出庫失敗:", err);
                     alert("出庫失敗: " + err.message);
                } finally {
                    button.disabled = false;
                    button.textContent = "確認出庫";
                }
            });

            // 9. QR Code (邏輯不變)
            function handleQrClick(e) {
                const id = e.currentTarget.dataset.id; 
                const name = e.currentTarget.dataset.name;

                qrCodeContainer.innerHTML = ''; 
                const url = `${location.origin}${location.pathname}?action=quickOutbound&id=${id}`;

                qrCodeTitle.textContent = name;
                
                try {
                    const qr = qrcode(0, 'M'); 
                    qr.addData(url);
                    qr.make();
                    
                    const imgTag = document.createElement('img');
                    imgTag.src = qr.createDataURL(10, 10); 
                    imgTag.style.width = '256px';
                    imgTag.style.height = '256px';
                    imgTag.style.margin = '0 auto';
                    imgTag.style.border = '1px solid #e2e8f0';
                    imgTag.style.borderRadius = '0.5rem';
                    
                    qrCodeContainer.appendChild(imgTag);
                    qrCodeModal.classList.remove('hidden');
                } catch (err) {
                    console.error('QR Code 產生失敗:', err);
                    qrCodeContainer.innerHTML = '<p class="text-red-500 text-center">QR Code 產生失敗。</p>';
                    qrCodeModal.classList.remove('hidden');
                }
            }

            cancelQrCodeBtn.addEventListener('click', () => {
                qrCodeModal.classList.add('hidden');
            });

            // --- 輔助工具 ---
            function escapeHTML(str) {
                if (!str) return '';
                return str.replace(/[&<>"']/g, function(match) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            }
        }
    })(); // 呼叫 main
</script>

</body>
</html>

