<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>庫存管理系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .btn-action {
            transition: transform 0.1s ease-in-out, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .btn-action:hover:not(:disabled) {
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .btn-action:active:not(:disabled) {
            transform: scale(0.95);
        }
        .btn-action:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(50%) sepia(10%) saturate(200%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        .table-striped tbody tr:nth-child(odd) { background-color: #f9fafb; }
        .table-striped tbody tr:hover { background-color: #f1f5f9; }
        .row-disabled {
            background-color: #f1f5f9 !important; /* slate-200 */
            color: #64748b; /* slate-500 */
        }
        .row-disabled:hover {
             background-color: #e2e8f0 !important; /* slate-300 */
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        @keyframes toast-in {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        .toast.show { animation: toast-in 0.3s ease-out forwards; }
        .toast.hide { animation: toast-out 0.3s ease-in forwards; }
    </style>
</head>
<body class="min-h-screen antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- 應用程式標題 -->
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-bold text-slate-800 flex justify-center items-center">
                <i data-lucide="package-search" class="w-10 h-10 mr-4 text-indigo-600"></i>庫存管理系統
            </h1>
        </header>

        <!-- 新增耗材表單 -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-10">
            <div class="flex justify-between items-center mb-5 border-b border-slate-200 pb-4">
                <h2 class="text-xl font-semibold text-slate-700 flex items-center">
                    <i data-lucide="plus-circle" class="mr-2 text-indigo-500"></i>新增耗材
                </h2>
                <div class="flex items-center space-x-2">
                    <button id="download-csv-btn" class="text-sm bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors flex items-center">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>下載庫存報表
                    </button>
                    <button id="manage-mappings-btn" class="text-sm bg-slate-100 text-slate-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition-colors flex items-center">
                        <i data-lucide="settings-2" class="w-4 h-4 mr-2"></i>管理品項
                    </button>
                </div>
            </div>
            <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="relative">
                    <label for="item-purchase-number" class="block text-sm font-medium text-slate-600 mb-1">採購編號 (可搜尋關鍵字)</label>
                    <input type="text" id="item-purchase-number" placeholder="輸入編號、名稱或品項關鍵字" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" autocomplete="off">
                    <div id="purchase-number-feedback" class="text-sm text-red-500 mt-1 h-4"></div>
                    <div id="purchase-number-results" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-60 overflow-y-auto hidden shadow-lg custom-scrollbar"></div>
                </div>
                <div>
                    <label for="item-name" class="block text-sm font-medium text-slate-600 mb-1">耗材名稱</label>
                    <input type="text" id="item-name" placeholder="將自動帶入" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition bg-slate-50" readonly>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <label for="item-category" class="block text-sm font-medium text-slate-600 mb-1">耗材類別</label>
                        <button type="button" id="add-category-btn" class="text-indigo-600 hover:text-indigo-800 font-bold mb-1 rounded-full w-6 h-6 flex items-center justify-center bg-indigo-100 hover:bg-indigo-200 transition-colors" title="新增類別">+</button>
                    </div>
                    <select id="item-category" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition bg-slate-50" disabled>
                        <option value="" disabled selected>將自動帶入</option>
                    </select>
                </div>
                <div>
                    <label for="item-purchase-date" class="block text-sm font-medium text-slate-600 mb-1">進貨日期</label>
                    <input type="date" id="item-purchase-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div>
                    <label for="item-quantity" class="block text-sm font-medium text-slate-600 mb-1">本次入庫數量</label> <!-- Changed Label -->
                    <input type="number" id="item-quantity" value="1" min="1" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"> <!-- Changed min to 1 -->
                </div>
                 <div>
                    <label for="item-remarks" class="block text-sm font-medium text-slate-600 mb-1">備註 (此筆紀錄)</label> <!-- Changed Label -->
                    <textarea id="item-remarks" rows="1" placeholder="新增備註..." class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors btn-action flex items-center justify-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> 新增此筆庫存紀錄
                    </button> <!-- Changed Button Text -->
                </div>
            </form>
        </div>

        <!-- 庫存清單 -->
        <div id="inventory-container">
             <div id="loading-state" class="text-center py-10">
                 <div class="flex justify-center items-center space-x-2">
                     <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                     </svg>
                     <p class="text-slate-500">正在連接資料庫...</p>
                 </div>
             </div>
             <!-- 庫存總覽 -->
             <div id="inventory-list-section" class="hidden">
                 <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                     <h2 class="text-2xl font-bold text-slate-800">庫存總覽</h2>
                     <div id="view-toggle" class="flex items-center rounded-lg bg-slate-200 p-1 self-start sm:self-center">
                         <button data-view="card" class="p-2 rounded-md transition-colors" title="卡片視圖"><i data-lucide="layout-grid" class="w-5 h-5 pointer-events-none"></i></button>
                         <button data-view="table" class="p-2 rounded-md transition-colors" title="表格視圖"><i data-lucide="list" class="w-5 h-5 pointer-events-none"></i></button>
                     </div>
                 </div>
                 <div id="inventory-list" class="space-y-4"></div>
             </div>

             <!-- 拆封紀錄 -->
             <div id="unseal-history-section" class="mt-12 hidden">
                 <h3 class="text-xl font-semibold text-slate-700 mb-4 border-b-2 border-slate-200 pb-2 flex items-center">
                     <i data-lucide="history" class="mr-3 text-slate-500"></i>最近拆封紀錄
                 </h3>
                 <div id="unseal-history-list" class="space-y-2 bg-white p-4 rounded-xl shadow-md">
                     <!-- History items will be injected here -->
                 </div>
             </div>

        </div> <!-- This is the end of inventory-container -->

        <!-- New Log Section Moved Here -->
        <div id="mappings-log-container" class="mt-12 hidden">
            <h3 class="text-xl font-semibold text-slate-700 mb-4 border-b-2 border-slate-200 pb-2 flex items-center">
                <i data-lucide="clipboard-list" class="mr-3 text-slate-500"></i>紀錄
            </h3>
            <div id="mappings-log-list" class="max-h-60 overflow-y-auto space-y-2 pr-2 custom-scrollbar text-sm text-slate-600 bg-white p-4 rounded-xl shadow-md">
                <p class="text-slate-400">正在載入紀錄...</p>
            </div>
        </div>
        <!-- End New Log Section -->

    </div> <!-- This is the end of div.container -->
    
    <!-- Modals -->
    <div id="mappings-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white w-full max-w-2xl p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800">管理品項對照表</h3>
                <button id="close-mappings-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="mb-6 bg-slate-50 p-4 rounded-lg">
                <h4 id="mapping-form-title" class="font-semibold text-slate-700 mb-2">新增對照品項</h4>
                <form id="add-mapping-form" class="space-y-3">
                    <div>
                        <label for="new-purchase-number" class="text-sm font-medium text-slate-600">採購編號</label>
                        <input type="text" id="new-purchase-number" placeholder="請輸入採購編號" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="new-item-name" class="text-sm font-medium text-slate-600">耗材名稱</label>
                        <input type="text" id="new-item-name" placeholder="請輸入對應的耗材名稱" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="new-item-category" class="text-sm font-medium text-slate-600">耗材類別 (品項)</label>
                        <select id="new-item-category" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition bg-white"></select>
                    </div>
                    <div id="mapping-form-buttons" class="!mt-4 space-y-2">
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn-action">儲存品項</button>
                    </div>
                </form>
            </div>
            <div id="mappings-list-container" class="max-h-80 overflow-y-auto space-y-4 pr-2 custom-scrollbar"></div>
            
            <!-- New Log Section - REMOVED FROM HERE -->

        </div>
    </div>

    <div id="add-stock-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
         <div class="modal-content bg-white w-full max-w-md p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800">添加入庫紀錄 (增加現有項目數量)</h3> <!-- Changed Title -->
                <button id="close-add-stock-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="add-stock-form" class="space-y-4">
                <div>
                    <label for="add-stock-date" class="block text-sm font-medium text-slate-600 mb-1">入庫日期</label>
                    <input type="date" id="add-stock-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <div>
                    <label for="add-stock-quantity" class="block text-sm font-medium text-slate-600 mb-1">添加入庫數量</label> <!-- Changed Label -->
                    <input type="number" id="add-stock-quantity" min="1" value="1" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <div class="!mt-6">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn-action">確認入庫</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-item-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
         <div class="modal-content bg-white w-full max-w-lg p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800">編輯此筆庫存項目</h3> <!-- Changed Title -->
                <button id="close-edit-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="edit-item-form" class="space-y-4">
                 <!-- Added Name and Category (Readonly) -->
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-500 mb-1">耗材名稱</label>
                        <p id="edit-item-name-display" class="font-semibold text-slate-800"></p>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-slate-500 mb-1">採購編號</label>
                        <p id="edit-purchase-number-display" class="font-semibold text-slate-800"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-last-purchase-date" class="block text-sm font-medium text-slate-600 mb-1">此筆入庫日期</label> <!-- Changed Label -->
                        <input type="date" id="edit-last-purchase-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="edit-quantity" class="block text-sm font-medium text-slate-600 mb-1">此筆目前庫存</label> <!-- Changed Label -->
                        <input type="number" id="edit-quantity" min="0" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                     <div>
                        <label for="edit-purchase-status" class="block text-sm font-medium text-slate-600 mb-1">財編狀態</label>
                        <input type="text" id="edit-purchase-status" placeholder="例如: P2025-001" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                </div>
                <div class="sm:col-span-2">
                    <label for="edit-remarks" class="block text-sm font-medium text-slate-600 mb-1">備註 (此筆紀錄)</label> <!-- Changed Label -->
                    <textarea id="edit-remarks" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition"></textarea>
                </div>
                <div class="!mt-6">
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors btn-action">更新此筆紀錄</button> <!-- Changed Button Text -->
                </div>
            </form>
        </div>
    </div>

     <div id="confirmation-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
         <div class="modal-content bg-white w-full max-w-sm p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10 text-center">
             <div id="confirmation-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                 <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
             </div>
             <h3 id="confirmation-title" class="text-lg font-semibold text-slate-800 mb-2"></h3>
             <p id="confirmation-message" class="text-slate-600 mb-6"></p>
             <div class="flex justify-center gap-4">
                 <button id="cancel-confirmation-btn" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
                 <button id="confirm-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">確認</button>
             </div>
         </div>
     </div>


    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100]"></div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDocs,
            setDoc, updateDoc, deleteDoc, writeBatch, query, limit,
            addDoc, orderBy // Added
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS ---
        const CONSTANTS = {
            MAPPINGS_COLLECTION: `mappings`,
            CUSTOM_CATEGORIES_COLLECTION: `custom_categories`,
            SUPPLIES_COLLECTION: `supplies`,
            MAPPING_LOGS_COLLECTION: `mapping_logs`, // New
            VIEW_MODE_KEY: `inventory_view_${getAppId()}`,
            INK_LOW_STOCK_THRESHOLD: 2,
            OTHER_LOW_STOCK_THRESHOLD: 3,
        };
        
        // Corrected and embedded CSV data
        const csvData = `品項,採購編號,耗材名稱,財編狀態,備註
90薄布,94-618-PIFB2006050,"防水絹布(薄油畫布)60"" (切工36""+24"",50米)",,"2023/10/12廠商說防水絹布(薄油畫布)60"" 50m為期貨商品,之後改訂36"",廠商報價36“單價較44”便宜,所以44”的價錢會有問題(單價*吋數),之後若有叫修60""商品再詢問廠商(2024/02/26廠商說已無販售)"
110薄布,94-618-PIFB2006050,"防水絹布(薄油畫布)60"" (切工44""+16"",50米)",,
60薄布(停用),94-620-PIFB20024,"防水絹布(薄油畫布)24""(30米)",停用編號,
90薄布(停用),94-620-PIFB20036,"防水絹布(薄油畫布)36""(30米)",停用編號,
110薄布(停用),94-620-PIFB20044,"防水絹布(薄油畫布)44""(30米)",停用編號,
90厚布,94-620-PIFO30036,藝術 防水霧面油畫布36吋 30米(台製),,
110厚布,94-620-PIFO30044,藝術 防水霧面油畫布44吋 30米(台製),,
60厚布(停用),,藝術 防水霧面油畫布24吋 30米(台製),停用編號,
90海報紙(停用),94-620-PIBA11036,"防水INKJET海報紙110磅36""(45米)",停用編號,"2024/02/26廠商說海報紙110磅之後沒有36""(45米)的,都改為30米"
110海報紙(停用),94-620-PIBA11044,"防水INKJET海報紙110磅44""(45米)",停用編號,"2024/02/26廠商說海報紙110磅之後沒有44""(45米)的,都改為30米,下次進貨規格更改為110磅42""(45米)廠商說單價一樣"
90專用紙,94-620-S041225,"EPSON 9000 銅西紙36""*25M 台製<薄專用紙>",財產編號,(停用)銅西紙135磅36吋*30M(台製),銅西紙150P,2025/2/27起不會再進貨銅西紙
90專用紙(新材編),94618PIBA17036,"防水噴墨厚卡海報紙170磅30米36""<台製170磅>",,"2025/5/2防水噴墨厚卡海報紙170磅30米36""舊料號94-618-PIBA17036,有料號94-620-PIBA170T36 36""X30m,防水噴墨厚卡海報紙170磅30米36"""
110專用紙,94-620-S041224,"EPSON 9000 滾筒紙44""*25M 台製<薄專用紙>",,
90銅板打樣紙,94-620-PIAA13536,防水噴墨銅版打樣紙135磅30米36吋,,
90背膠亮面相紙,94-620-PIAF170T36,背膠超光亮面相紙170磅18米36吋,,
90自黏白霧面,94-620-PID200ST36,防水PVC自黏白霧面200磅30米36吋(貼紙),,
90原廠相紙,94-618-S041391,"EPSON 頂級光面相紙36""*30.5m S041391<原廠170磅>",,
110原廠相紙,94-618-S041640,"EPSON 頂級光面相紙44""*30.5m S041640<原廠250磅>",,
T8041亮光黑/PK,94-618-T804100,EPSON SCP9000亮光黑色墨水匣PK/700ML,,
T8042藍色/C,94-618-T804200,EPSON SCP9000藍色墨水匣C/700ML,,
T8043靚紅色/VM,94-618-T804300,EPSON SCP9000靚紅色墨水匣VM/700ML,,
T8044黃色/Y,94-618-T804400,EPSON SCP9000黃色墨水匣Y/700ML,,
T8045淡藍色/LC,94-618-T804500,EPSON SCP9000淡藍色墨水匣LC/700ML,,
T8046淡靚紅色/VLM,94-618-T804600,EPSON SCP9000淡靚紅色墨水匣VLM/700ML,,
T8047淡黑色/LK,94-618-T804700,EPSON SCP9000淡黑色墨水匣LK/700ML,,
T8048消光黑/MK,94-618-T804800,EPSON SCP9000消光黑色墨水匣MK/700ML,,
T8049超淡黑/LLK,94-618-T804900,EPSON SCP9000超淡黑色墨水匣LLK/700ML,,
T804A橘色/OR,94-618-T804A00,EPSON SCP9000橘色墨水匣OR/700ML,,
T804B綠色/GR,94-618-T804B00,EPSON SCP9000綠色墨水匣GR/700ML,,
捲筒配接器,94-620-C811241,EPSON SCP9000捲筒配接器,,
墨水收集槽,94-618-T699700,EPSON SCP9000廢墨盒,,`;

        // --- DOM Elements ---
        const DOM = {
            inventoryContainer: document.getElementById('inventory-container'),
            loadingState: document.getElementById('loading-state'),
            inventoryList: document.getElementById('inventory-list'),
            inventoryListSection: document.getElementById('inventory-list-section'),
            purchaseNumberInput: document.getElementById('item-purchase-number'),
            itemNameInput: document.getElementById('item-name'),
            categorySelect: document.getElementById('item-category'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            itemPurchaseDate: document.getElementById('item-purchase-date'),
            manageMappingsBtn: document.getElementById('manage-mappings-btn'),
            mappingsModal: document.getElementById('mappings-modal'),
            closeMappingsModalBtn: document.getElementById('close-mappings-modal-btn'),
            addMappingForm: document.getElementById('add-mapping-form'),
            mappingsListContainer: document.getElementById('mappings-list-container'),
            newItemCategorySelect: document.getElementById('new-item-category'),
            purchaseNumberFeedback: document.getElementById('purchase-number-feedback'),
            purchaseNumberResults: document.getElementById('purchase-number-results'),
            mappingFormTitle: document.getElementById('mapping-form-title'),
            mappingFormButtons: document.getElementById('mapping-form-buttons'),
            viewToggle: document.getElementById('view-toggle'),
            addStockModal: document.getElementById('add-stock-modal'),
            closeAddStockModalBtn: document.getElementById('close-add-stock-modal-btn'),
            addStockForm: document.getElementById('add-stock-form'),
            editItemModal: document.getElementById('edit-item-modal'),
            closeEditModalBtn: document.getElementById('close-edit-modal-btn'),
            editItemForm: document.getElementById('edit-item-form'),
            confirmationModal: document.getElementById('confirmation-modal'),
            unsealHistorySection: document.getElementById('unseal-history-section'),
            unsealHistoryList: document.getElementById('unseal-history-list'),
            downloadCsvBtn: document.getElementById('download-csv-btn'),
        };

        // --- State ---
        let db;
        let auth;
        let userId;
        let allSupplies = [];
        let purchaseNumberMap = {};
        let editingKey = null;
        let currentView = localStorage.getItem(CONSTANTS.VIEW_MODE_KEY) || 'card';
        let currentlyEditingItemId = null; // Will now store the unique Firestore ID
        let mappingLogUnsubscribe = null; // New listener handle
        
        const majorCategoryMap = {
             '90薄布': '滾筒布', '110薄布': '滾筒布', '60薄布(停用)': '滾筒布', '90薄布(停用)': '滾筒布', '110薄布(停用)': '滾筒布', '90厚布': '滾筒布', '110厚布': '滾筒布', '60厚布(停用)': '滾筒布',
            '90海報紙': '滾筒紙', '110海報紙': '滾筒紙', '90專用紙': '滾筒紙', '90專用紙(新材編)': '滾筒紙', '110專用紙': '滾筒紙', '90銅板打樣紙': '滾筒紙', '90背膠亮面相紙': '滾筒紙', '90自黏白霧面': '滾筒紙', '90原廠相紙': '滾筒紙', '110原廠相紙': '滾筒紙', '90海報紙(停用)': '滾筒紙', '110海報紙(停用)': '滾筒紙',
            'T8041亮光黑/PK': '墨水匣', 'T8042藍色/C': '墨水匣', 'T8043靚紅色/VM': '墨水匣', 'T8044黃色/Y': '墨水匣', 'T8045淡藍色/LC': '墨水匣', 'T8046淡靚紅色/VLM': '墨水匣', 'T8047淡黑色/LK': '墨水匣', 'T8048消光黑/MK': '墨水匣', 'T8049超淡黑/LLK': '墨水匣', 'T804A橘色/OR': '墨水匣', 'T804B綠色/GR': '墨水匣',
            '捲筒配接器': '其他', '墨水收集槽': '其他'
        };

        // --- Helper Functions ---
        function getAppId() {
            // For GitHub deployment, use a fixed App ID. 
            // This ensures all users on your GitHub Pages site share the same database.
            return 'epson9000-inventory-app-github'; 
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' 
                ? `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>` 
                : `<i data-lucide="x-circle" class="w-5 h-5 text-red-500"></i>`;
            
            toast.className = `toast flex items-center gap-3 bg-white shadow-2xl rounded-lg py-3 px-4 mb-2 transition-transform duration-300`;
            toast.innerHTML = `${icon}<p class="font-semibold text-slate-700">${message}</p>`;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.add('hide');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }
        
        // --- DATA LOADING AND PROCESSING ---
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }


        function getInitialDataFromCSV() {
            const lines = csvData.trim().split('\n').slice(1); // Skip header
            const suppliesFromCsv = lines.map(line => {
                if (!line.trim()) return null;
                const [category, purchaseNumber, name, purchaseStatus, remarks] = parseCsvLine(line.trim());
                
                const cleanedPurchaseNumber = purchaseNumber.replace(/"/g, '').trim();
                const cleanedName = name.replace(/"/g, '').trim();

                if (!cleanedPurchaseNumber && !cleanedName) return null;

                // **Generate a unique ID here for seeding**
                const uniqueId = crypto.randomUUID(); 

                return {
                    id: uniqueId, // Use the generated unique ID
                    purchaseNumber: cleanedPurchaseNumber || `manual-${cleanedName}`, // Keep purchase number as data
                    name: cleanedName,
                    category: category.replace(/"/g, '').trim(),
                    purchaseStatus: purchaseStatus.replace(/"/g, '').trim(),
                    remarks: remarks.replace(/"/g, '').trim(),
                    quantity: 0,
                    lastPurchaseDate: '',
                    usageHistory: [],
                    inboundHistory: [],
                };
            }).filter(Boolean);
            return suppliesFromCsv;
        }

        // --- UI Rendering ---
        function renderInventory() {
            // Check if loading state is still present before modifying UI
            if (DOM.loadingState && DOM.loadingState.style.display !== 'none') {
                 DOM.inventoryListSection.style.display = 'block';
                 DOM.loadingState.style.display = 'none';
            }
            const mainListContainer = DOM.inventoryList;

            mainListContainer.innerHTML = '';
            mainListContainer.className = 'space-y-8';
            
            // Sort supplies by name primarily, then maybe by purchase date or ID secondarily?
            // Let's sort by name, then purchase number for grouping visual consistency
            const sortedSupplies = [...allSupplies].sort((a, b) => {
                const nameCompare = a.name.localeCompare(b.name, 'zh-Hant');
                if (nameCompare !== 0) return nameCompare;
                return (a.purchaseNumber || '').localeCompare(b.purchaseNumber || '', 'zh-Hant');
            });

            const activeItems = sortedSupplies.filter(item => !item.name.includes('(停用)') && !(item.purchaseStatus && item.purchaseStatus.includes('停用')));
            const discontinuedItems = sortedSupplies.filter(item => item.name.includes('(停用)') || (item.purchaseStatus && item.purchaseStatus.includes('停用')));

             const groupedActiveItems = activeItems.reduce((acc, item) => {
                 const majorCat = majorCategoryMap[item.category] || '其他';
                 if (!acc[majorCat]) acc[majorCat] = [];
                 acc[majorCat].push(item);
                 return acc;
             }, {});

            const categoryOrder = ['滾筒布', '滾筒紙', '墨水匣', '其他'];
            const categoryIcons = { '滾筒布': 'layers', '滾筒紙': 'file-stack', '墨水匣': 'droplets', '其他': 'package' };

            if (activeItems.length > 0) {
                 categoryOrder.forEach(majorCat => {
                     const itemsInCategory = groupedActiveItems[majorCat];
                     if (itemsInCategory && itemsInCategory.length > 0) {
                         const groupContainer = document.createElement('div');
                         groupContainer.innerHTML = `
                             <h3 class="text-lg font-semibold text-slate-700 mb-3 border-b pb-2 flex items-center">
                                 <i data-lucide="${categoryIcons[majorCat] || 'package'}" class="w-5 h-5 mr-2 text-slate-500"></i>
                                 ${majorCat}
                             </h3>`;
                         
                         const subListContainer = document.createElement('div');
                         renderGroup(subListContainer, itemsInCategory); // Pass sorted items
                         groupContainer.appendChild(subListContainer);
                         mainListContainer.appendChild(groupContainer);
                     }
                 });
            } else {
                 mainListContainer.innerHTML = `<div class="text-center py-10 bg-slate-50 rounded-lg"><i data-lucide="inbox" class="mx-auto h-12 w-12 text-slate-400"></i><h3 class="mt-2 text-sm font-medium text-slate-900">沒有任何項目</h3><p class="mt-1 text-sm text-slate-500">請先新增耗材或管理品項。</p></div>`;
            }

            if (discontinuedItems.length > 0) {
                const discontinuedSection = document.createElement('div');
                discontinuedSection.className = 'mt-12';
                discontinuedSection.innerHTML = `
                    <h2 class="text-2xl font-bold text-slate-500 mb-4 border-b pb-2 flex items-center">
                        <i data-lucide="archive" class="w-6 h-6 mr-3 text-slate-400"></i>
                        停用項目
                    </h2>
                `;
                const discontinuedContainer = document.createElement('div');
                renderGroup(discontinuedContainer, discontinuedItems); // Pass sorted discontinued items
                discontinuedSection.appendChild(discontinuedContainer);
                mainListContainer.appendChild(discontinuedSection);
            }

            lucide.createIcons();
        }


        function renderGroup(container, items) { // Items are now pre-sorted
            if (items.length === 0) return;
            
             if (currentView === 'card') {
                 container.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4';
                 items.forEach(item => { // No need to sort again
                     container.appendChild(createItemCard(item));
                 });
             } else {
                 container.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                 const tableHTML = `
                     <table class="w-full text-sm text-left text-slate-500 table-striped">
                         <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                             <tr>
                                 <th scope="col" class="px-4 py-3">耗材名稱</th>
                                 <th scope="col" class="px-4 py-3">採購編號</th>
                                 <th scope="col" class="px-4 py-3">財編狀態</th>
                                 <th scope="col" class="px-4 py-3 text-center">庫存</th>
                                 <th scope="col" class="px-4 py-3 text-center">操作</th>
                             </tr>
                         </thead>
                         <tbody>
                             ${items.map(createItemTableRow).join('')} <!-- No need to sort again -->
                         </tbody>
                     </table>`;
                 container.innerHTML = tableHTML;
                 addTableEventListeners(container);
             }
        }

        function createItemCard(item) {
            const itemCard = document.createElement('div');
            
            const isInk = (majorCategoryMap[item.category] || '其他') === '墨水匣';
            const threshold = isInk ? CONSTANTS.INK_LOW_STOCK_THRESHOLD : CONSTANTS.OTHER_LOW_STOCK_THRESHOLD;
            const isLowStock = item.quantity < threshold && item.quantity > 0;
            const isZero = item.quantity === 0;
            const isDiscontinued = item.name.includes('(停用)') || (item.purchaseStatus && item.purchaseStatus.includes('停用'));

            let cardClasses = 'bg-white rounded-lg shadow p-4 flex flex-col justify-between transition-all hover:shadow-lg hover:-translate-y-1 relative overflow-hidden';
            if (isDiscontinued) {
                 cardClasses += ' opacity-60 bg-slate-100';
            }
            if (isZero && !isDiscontinued) {
                 cardClasses += ' border-2 border-red-400 ring-4 ring-red-100/50';
            } else if (isLowStock && !isDiscontinued) {
                cardClasses += ' border-2 border-amber-400 ring-4 ring-amber-100/50';
            }
            
            let purchaseAlertHtml = '';
            if (isZero && !isDiscontinued) {
                purchaseAlertHtml = `<div class="mb-3 flex items-center p-2 rounded-md bg-red-100 text-red-800 text-sm font-bold">
                            <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>
                            <span>庫存已歸零 (建議庫存: ${threshold})</span>
                        </div>`;
            } else if (isLowStock && !isDiscontinued) {
                 purchaseAlertHtml = `<div class="mb-3 flex items-center p-2 rounded-md bg-amber-100 text-amber-800 text-sm font-bold">
                            <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                            <span>請盡快採購 (建議庫存: ${threshold})</span>
                        </div>`;
            }

            const actionButtonsHtml = `
                <div class="flex items-center justify-between mt-4 pt-3 border-t">
                    <div class="flex items-center space-x-2">
                        <button data-action="decrease" class="btn-action bg-slate-200 text-slate-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-300 text-lg font-bold" ${item.quantity <= 0 ? 'disabled' : ''}>-</button>
                        <span data-role="quantity-display" class="font-bold text-xl text-slate-800 w-10 text-center">${item.quantity}</span>
                        <button data-action="increase" class="btn-action bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-green-200 text-lg font-bold">+</button>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button data-action="unseal" class="btn-action bg-blue-100 text-blue-600 rounded-md h-8 px-3 flex items-center justify-center hover:bg-blue-200 text-xs font-semibold" ${item.quantity <= 0 ? 'disabled' : ''}>拆封</button>
                        <button data-action="edit" class="btn-action text-slate-500 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-200 hover:text-indigo-600"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button data-action="delete" class="btn-action text-slate-500 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-200 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `;

            itemCard.className = cardClasses;
            itemCard.dataset.itemId = item.id; // **Use the unique ID**
            itemCard.innerHTML = `
                <div>
                    ${purchaseAlertHtml}
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex-1 pr-2">${item.name}</h3>
                        <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-100 flex-shrink-0">${item.category || '未分類'}</span>
                    </div>
                    <div class="mt-2 space-y-1 text-xs text-slate-500">
                        <p>採購編號: <span class="font-medium text-slate-600">${item.purchaseNumber || 'N/A'}</span></p>
                        <p>此筆入庫: <span class="font-medium text-slate-600">${item.lastPurchaseDate || '---'}</span></p> <!-- Changed Label -->
                        <p>財編狀態: <span class="font-medium text-slate-600">${item.purchaseStatus || 'N/A'}</span></p>
                        ${item.remarks ? `<p class="mt-2 pt-2 border-t border-slate-200">備註: <span class="font-normal text-slate-600 whitespace-pre-wrap">${item.remarks}</span></p>` : ''}
                    </div>
                </div>
                ${actionButtonsHtml}
                `;
            
            addCardEventListeners(itemCard, item);
            return itemCard;
        }

        function createItemTableRow(item) {
            const isInk = (majorCategoryMap[item.category] || '其他') === '墨水匣';
            const threshold = isInk ? CONSTANTS.INK_LOW_STOCK_THRESHOLD : CONSTANTS.OTHER_LOW_STOCK_THRESHOLD;
            const isLowStock = item.quantity < threshold && item.quantity > 0;
            const isZero = item.quantity === 0;
            const isDiscontinued = item.name.includes('(停用)') || (item.purchaseStatus && item.purchaseStatus.includes('停用'));

            let rowClasses = 'border-b transition-colors';
             if (isDiscontinued) {
                 rowClasses += ' row-disabled';
             } else if (isZero) {
                rowClasses += ' bg-red-50 hover:bg-red-100';
            } else if (isLowStock) {
                 rowClasses += ' bg-amber-50 hover:bg-amber-100';
            }

            let nameCellContent = `<div>${item.name || 'N/A'}</div>`;
            // Add purchase date to table row for distinction
            nameCellContent += `<div class="text-xs text-slate-400 mt-1">入庫: ${item.lastPurchaseDate || '---'}</div>`
             if (item.remarks) {
                 nameCellContent += `<div class="text-xs text-slate-500 mt-1 whitespace-pre-wrap">備註: ${item.remarks}</div>`;
             }
            if (isZero && !isDiscontinued) {
                nameCellContent = `<div>
                    <div class="flex items-center font-bold text-red-800"><i data-lucide="shopping-cart" class="w-4 h-4 mr-2"></i><span>${item.name || 'N/A'}</span></div>
                    <div class="text-xs text-slate-400 mt-1">入庫: ${item.lastPurchaseDate || '---'}</div>
                    <div class="text-xs text-red-600 font-semibold mt-1">庫存已歸零 (建議庫存: ${threshold})</div>
                </div>`;
            } else if (isLowStock && !isDiscontinued) {
                 nameCellContent += `<div class="text-xs text-amber-600 font-semibold flex items-center mt-1"><i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i>請盡快採購 (建議庫存: ${threshold})</div>`;
            }
            
            const actionButtonsCell = `
                <div class="flex items-center justify-center space-x-1">
                    <button data-action="unseal" class="btn-action bg-blue-100 text-blue-600 rounded-md h-7 px-3 flex items-center justify-center hover:bg-blue-200 text-xs font-semibold" ${item.quantity <= 0 ? 'disabled' : ''}>拆封</button>
                    <button data-action="decrease" class="btn-action bg-slate-100 text-slate-600 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-200 text-base font-bold" ${item.quantity <= 0 ? 'disabled' : ''}>-</button>
                    <button data-action="increase" class="btn-action bg-green-100 text-green-700 rounded-md w-7 h-7 flex items-center justify-center hover:bg-green-200 text-base font-bold">+</button>
                    <button data-action="edit" class="btn-action text-slate-500 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-200 hover:text-indigo-600"><i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i></button>
                    <button data-action="delete" class="btn-action text-slate-500 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-200 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            `;

            return `
                <tr class="${rowClasses}" data-item-id="${item.id}"> <!-- Use unique ID -->
                    <td class="px-4 py-3 font-medium">${nameCellContent}</td>
                    <td class="px-4 py-3">${item.purchaseNumber || 'N/A'}</td>
                    <td class="px-4 py-3">${item.purchaseStatus || 'N/A'}</td>
                    <td class="px-4 py-3 text-center"><span data-role="quantity-display" class="font-bold text-base">${item.quantity}</span></td>
                    <td class="px-4 py-3 text-center">${actionButtonsCell}</td>
                </tr>`;
        }
        
        function renderUnsealHistory() {
            const historyList = DOM.unsealHistoryList;
            historyList.innerHTML = '';
            
            const allHistory = allSupplies
                // Include purchase date in history entry for context
                .flatMap(item => (item.usageHistory || []).map(h => ({ ...h, name: item.name, category: item.category, itemId: item.id, itemPurchaseDate: item.lastPurchaseDate }))) 
                .sort((a, b) => new Date(b.unsealedDate) - new Date(a.unsealedDate));

            if (allHistory.length > 0) {
                DOM.unsealHistorySection.style.display = 'block';
                allHistory.slice(0, 15).forEach(entry => { // Show latest 15
                    const li = document.createElement('div');
                    li.className = 'text-sm text-slate-600 border-b border-slate-100 py-2 flex justify-between items-center';
                    li.innerHTML = `
                        <div class="flex-1">
                            <span class="font-semibold text-slate-800">${entry.name}</span>
                            <span class="text-xs text-slate-400 ml-2">(${majorCategoryMap[entry.category] || '其他'})</span>
                            <span class="text-xs text-slate-400 ml-2">[入庫:${entry.itemPurchaseDate || 'N/A'}]</span> <!-- Show item purchase date -->
                        </div>
                        <div class="flex items-center gap-3">
                           <span class="text-xs font-mono bg-slate-100 text-slate-500 px-2 py-0.5 rounded">${entry.unsealedDate}</span>
                           <button data-item-id="${entry.itemId}" data-history-id="${entry.id}" class="delete-history-btn text-slate-400 hover:text-red-500" title="刪除此紀錄">
                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                           </button>
                        </div>
                    `;
                    historyList.appendChild(li);
                });
                lucide.createIcons();
            } else {
                DOM.unsealHistorySection.style.display = 'none';
            }
        }
        
        // --- Event Listener Helpers ---
        function addCardEventListeners(card, item) {
            card.addEventListener('click', (e) => handleItemAction(e, item.id)); // Pass unique ID
        }

        function addTableEventListeners(table) {
            table.addEventListener('click', (e) => {
                const row = e.target.closest('tr[data-item-id]');
                if (row) {
                    const itemId = row.dataset.itemId; // Get unique ID
                    // No need to find item here, just pass the ID
                    handleItemAction(e, itemId);
                }
            });
        }
        
        // **Modified to accept itemId instead of the full item object**
        async function handleItemAction(e, itemId) { 
            const button = e.target.closest('button[data-action]');
            if (!button || button.disabled) return;
            const action = button.dataset.action;

            // Find the item from the current state using the unique ID
            const item = allSupplies.find(s => s.id === itemId);
            if (!item) {
                console.error("Item not found for action:", itemId);
                showToast("操作失敗，找不到項目", "error");
                return;
            }

            const itemRef = doc(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION), item.id); // Use unique ID

            switch (action) {
                case 'increase':
                    openAddStockModal(item); // Pass the found item object
                    break;
                case 'decrease': {
                    const newQuantity = item.quantity - 1;
                    if (newQuantity < 0) return;
                    showConfirmation('確認出庫', `確定要將 "${item.name}" (入庫日期: ${item.lastPurchaseDate || 'N/A'}) 的庫存減 1 嗎？`, async () => { // Added date context
                        const today = new Date().toISOString().split('T')[0];
                        const historyEntry = { id: crypto.randomUUID(), unsealedDate: today, type: 'manual_decrease' };
                        const updatedHistory = [...(item.usageHistory || []), historyEntry];
                        await updateDoc(itemRef, { quantity: newQuantity, usageHistory: updatedHistory });
                        showToast('庫存已更新');
                    }, 'orange');
                    break;
                }
                case 'delete':
                    showConfirmation('確認刪除', `您確定要永久刪除這筆 "${item.name}" (入庫日期: ${item.lastPurchaseDate || 'N/A'}) 的庫存紀錄嗎？`, async () => { // Added date context
                        await deleteDoc(itemRef);
                        showToast('此筆庫存紀錄已刪除');
                    }, 'red');
                    break;
                case 'edit':
                    openEditModal(item); // Pass the found item object
                    break;
                case 'unseal': {
                     const newQuantity = item.quantity - 1;
                    if (newQuantity < 0) return;
                    showConfirmation('確認拆封', `確定要拆封一個 "${item.name}" (入庫日期: ${item.lastPurchaseDate || 'N/A'}) 嗎？此筆庫存將會減 1。`, async () => { // Added date context
                        const today = new Date().toISOString().split('T')[0];
                        const historyEntry = { id: crypto.randomUUID(), unsealedDate: today, type: 'unseal' };
                        const updatedHistory = [...(item.usageHistory || []), historyEntry];
                        await updateDoc(itemRef, { quantity: newQuantity, usageHistory: updatedHistory });
                        showToast('庫存已更新，已記錄拆封');
                    }, 'blue');
                    break;
                }
            }
        }
        
        // --- Modal & Confirmation Logic ---
        function openModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('opacity-0', '-translate-y-10');
            }, 10);
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('opacity-0', '-translate-y-10');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (modal === DOM.mappingsModal) {
                    if (editingKey) cancelEditMode();
                    // Stop listening to logs when modal closes - REMOVED
                }
                 // Reset currentlyEditingItemId when closing relevant modals
                if (modal === DOM.addStockModal || modal === DOM.editItemModal) {
                    currentlyEditingItemId = null; 
                }
            }, 300);
        }

        function showConfirmation(title, message, onConfirm, type = 'red') {
            const modal = DOM.confirmationModal;
            const confirmBtn = modal.querySelector('#confirm-btn');
            const iconContainer = modal.querySelector('#confirmation-icon');
            
            const typeMap = {
                red: { btn: 'bg-red-600 hover:bg-red-700', icon: 'bg-red-100', iconContent: `<i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>` },
                blue: { btn: 'bg-blue-600 hover:bg-blue-700', icon: 'bg-blue-100', iconContent: `<i data-lucide="info" class="h-6 w-6 text-blue-600"></i>` },
                orange: { btn: 'bg-orange-500 hover:bg-orange-600', icon: 'bg-orange-100', iconContent: `<i data-lucide="alert-circle" class="h-6 w-6 text-orange-600"></i>` }
            };

            modal.querySelector('#confirmation-title').textContent = title;
            modal.querySelector('#confirmation-message').textContent = message;
            
            confirmBtn.className = `w-full text-white font-semibold py-2 px-4 rounded-lg transition-colors ${typeMap[type].btn}`;
            iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 ${typeMap[type].icon}`;
            iconContainer.innerHTML = typeMap[type].iconContent;
            lucide.createIcons();
            
            const newConfirmHandler = () => {
                onConfirm();
                closeModal(modal);
            };
            
            const newCancelHandler = () => {
                closeModal(modal);
            };

            const confirmBtnClone = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(confirmBtnClone, confirmBtn);
            confirmBtnClone.addEventListener('click', newConfirmHandler, { once: true });

            const cancelBtn = modal.querySelector('#cancel-confirmation-btn');
            const cancelBtnClone = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(cancelBtnClone, cancelBtn);
            cancelBtnClone.addEventListener('click', newCancelHandler, { once: true });
            
            openModal(modal);
        }

        // --- Mappings and Category Logic ---
        function initializeAndLoadMappings() {
            // 1. Parse CSV data first to get base mappings
            const csvBasedMappings = {};
            const lines = csvData.trim().split('\n').slice(1); // Skip header
            lines.forEach(line => {
                if (!line.trim()) return;
                const [category, purchaseNumber, name] = parseCsvLine(line.trim());
                const cleanedPurchaseNumber = purchaseNumber.replace(/"/g, '').trim();
                const cleanedName = name.replace(/"/g, '').trim();
                const cleanedCategory = category.replace(/"/g, '').trim();

                if (cleanedPurchaseNumber) { // Only add if there's a purchase number
                    csvBasedMappings[cleanedPurchaseNumber] = { name: cleanedName, category: cleanedCategory };
                } else if (cleanedName) {
                    // Handle items with name but no number if needed, maybe using manual key?
                    // For consistency with seeding, let's keep the manual key logic
                    const manualKey = `manual-${cleanedName}`;
                    csvBasedMappings[manualKey] = { name: cleanedName, category: cleanedCategory };
                }
            });

            // 2. Listen to Firestore for updates
            const mappingsRef = collection(db, getCollectionPath(CONSTANTS.MAPPINGS_COLLECTION));
            onSnapshot(mappingsRef, (snapshot) => {
                const firestoreMappings = {};
                snapshot.forEach(doc => {
                    firestoreMappings[doc.id] = doc.data();
                });
                // 3. Merge Firestore data over CSV defaults
                purchaseNumberMap = { ...csvBasedMappings, ...firestoreMappings };
                renderMappingsList();
                populateCategorySelects();
            }, (error) => {
                 console.error("讀取品項對照表時發生錯誤:", error);
                 showToast('讀取品項對照表失敗', 'error');
                 // Initialize with CSV data even if Firestore fails initially
                 if (Object.keys(purchaseNumberMap).length === 0) { // Check if map wasn't already populated
                     purchaseNumberMap = { ...csvBasedMappings };
                     renderMappingsList();
                     populateCategorySelects();
                 }
            });
        }
        
        function renderMappingsList() {
            DOM.mappingsListContainer.innerHTML = '';
            
            const container = document.createElement('div');
            container.innerHTML = '<h4 class="font-semibold text-slate-700 mb-2">品項對照表</h4>';
            const list = document.createElement('div');
            list.className = 'space-y-2';

            const sortedKeys = Object.keys(purchaseNumberMap).sort();

            if (sortedKeys.length === 0) {
                list.innerHTML = '<p class="text-slate-500 text-sm">尚未建立任何品項。</p>';
            } else {
                let elementToScrollTo = null; // Variable to hold the element
                sortedKeys.forEach(number => {
                    const item = purchaseNumberMap[number];
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm bg-slate-100 p-2 rounded-md transition-all duration-300';
                    div.dataset.mappingKey = number; // Add a data-attribute for selection
                    div.innerHTML = `
                        <div>
                            <strong class="text-slate-800">${number}</strong>
                            <span class="text-slate-600 ml-2">${item.name} (${item.category})</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button data-key="${number}" class="edit-mapping-btn text-slate-500 hover:text-indigo-600" title="編輯">
                                <i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <button data-key="${number}" class="delete-mapping-btn text-slate-500 hover:text-red-600" title="刪除">
                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);

                    // Check if this is the item we want to scroll to
                    if (window.lastEditedMappingKey && window.lastEditedMappingKey === number) {
                        elementToScrollTo = div;
                        div.classList.add('bg-indigo-100', 'ring-2', 'ring-indigo-500'); // Highlight it
                    }
                });
                
                // After loop, scroll if element was found
                if (elementToScrollTo) {
                    elementToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Clear the flag
                    window.lastEditedMappingKey = null;
                    
                    // Remove highlight after a delay
                    setTimeout(() => {
                        elementToScrollTo.classList.remove('bg-indigo-100', 'ring-2', 'ring-indigo-500');
                    }, 2500);
                }
            }
            container.appendChild(list);
            DOM.mappingsListContainer.appendChild(container);
            lucide.createIcons();
        }

        function listenToMappingLogs() {
            // Clear old listener if it exists
            if (mappingLogUnsubscribe) {
                mappingLogUnsubscribe();
            }

            const logsRef = collection(db, getCollectionPath(CONSTANTS.MAPPING_LOGS_COLLECTION));
            const q = query(logsRef, orderBy('timestamp', 'desc'), limit(20)); // Get latest 20

            mappingLogUnsubscribe = onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach(doc => {
                    logs.push(doc.data());
                });
                renderMappingLogs(logs);
            }, (error) => {
                console.error("無法讀取品項日誌:", error);
                document.getElementById('mappings-log-list').innerHTML = '<p class="text-red-500">無法載入紀錄。</p>';
            });
        }

        function renderMappingLogs(logs) {
            const listEl = document.getElementById('mappings-log-list');
            if (!listEl) return;
            const containerEl = document.getElementById('mappings-log-container');

            if (logs.length === 0) {
                listEl.innerHTML = '<p class="text-slate-400">尚無任何操作紀錄。</p>';
                containerEl.style.display = 'block'; // Show even if empty
                return;
            }

            listEl.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp);
                const formattedDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                return `
                    <div class="border-b border-slate-200 pb-1 mb-1">
                        <p class="font-medium text-slate-700">${log.action}</p>
                        <p class="text-xs text-slate-500">${formattedDate}</p>
                    </div>
                `;
            }).join('');
            containerEl.style.display = 'block'; // Show the container
        }

        function startEditMode(key) {
            editingKey = key;
            const item = purchaseNumberMap[key];
            DOM.mappingFormTitle.textContent = '編輯對照品項';
            document.getElementById('new-purchase-number').value = key;
            document.getElementById('new-item-name').value = item.name;
            DOM.newItemCategorySelect.value = item.category;

            DOM.mappingFormButtons.innerHTML = `
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors btn-action">更新品項</button>
                <button type="button" id="cancel-edit-btn" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
            `;
            document.getElementById('cancel-edit-btn').addEventListener('click', cancelEditMode);
            DOM.addMappingForm.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditMode() {
            editingKey = null;
            DOM.addMappingForm.reset();
            DOM.mappingFormTitle.textContent = '新增對照品項';
            DOM.mappingFormButtons.innerHTML = `
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn-action">儲存品項</button>
            `;
        }

        async function populateCategorySelects() {
            const customCategoriesRef = collection(db, getCollectionPath(CONSTANTS.CUSTOM_CATEGORIES_COLLECTION));
            const snapshot = await getDocs(customCategoriesRef);
            const customCategories = snapshot.docs.map(doc => doc.id);
            // Derive categories also from the *current* purchaseNumberMap which includes CSV + Firestore
            const allCategories = [...new Set(Object.values(purchaseNumberMap).map(item => item.category))]; 
            const finalCategories = [...new Set([...allCategories, ...customCategories])].sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            
            const selects = [DOM.categorySelect, DOM.newItemCategorySelect];
            selects.forEach(select => {
                const currentVal = select.value;
                const placeholder = select.querySelector('option[disabled]');
                select.innerHTML = '';
                if(placeholder) select.appendChild(placeholder);
                
                finalCategories.forEach(categoryName => {
                    const option = document.createElement('option');
                    option.value = categoryName;
                    option.textContent = categoryName;
                    select.appendChild(option);
                });
                // Restore previous selection if possible, otherwise leave it (or set to placeholder if it exists)
                 if (finalCategories.includes(currentVal)) {
                     select.value = currentVal;
                 } else if (!placeholder) {
                     select.value = ''; // Or select the first available option?
                 }

            });
        }

        function addCategoryOption(categoryName, selectAfterAdding = false) {
            if (!categoryName) return;

            const selects = [DOM.categorySelect, DOM.newItemCategorySelect];
            selects.forEach(select => {
                 if (!Array.from(select.options).some(opt => opt.value === categoryName)){
                     const option = document.createElement('option');
                     option.value = categoryName;
                     option.textContent = categoryName;
                     select.appendChild(option);
                      // Re-sort options? Optional, might be complex if done frequently
                 }
            });
            
            if (selectAfterAdding) {
                // Ensure the category select is enabled before setting the value
                DOM.categorySelect.disabled = false;
                DOM.categorySelect.classList.remove('bg-slate-50');
                DOM.categorySelect.value = categoryName;
            }
        }

        async function saveCustomCategory(categoryName) {
            const categoryRef = doc(db, getCollectionPath(CONSTANTS.CUSTOM_CATEGORIES_COLLECTION), categoryName);
            await setDoc(categoryRef, { name: categoryName });
            populateCategorySelects(); // Refresh dropdowns after saving
        }


        // --- Update/Delete/Edit Functions ---
        
        function openAddStockModal(item) { // item is the full object
            currentlyEditingItemId = item.id; // Store unique ID
            DOM.addStockForm.reset();
            DOM.addStockForm['add-stock-date'].value = new Date().toISOString().split('T')[0];
            openModal(DOM.addStockModal);
        }

        function openEditModal(item) { // item is the full object
            currentlyEditingItemId = item.id; // Store unique ID
            // Populate display fields (readonly)
             document.getElementById('edit-item-name-display').textContent = item.name || 'N/A';
             document.getElementById('edit-purchase-number-display').textContent = item.purchaseNumber || 'N/A';
            // Populate editable fields
            DOM.editItemForm['edit-last-purchase-date'].value = item.lastPurchaseDate || '';
            DOM.editItemForm['edit-quantity'].value = item.quantity;
            DOM.editItemForm['edit-purchase-status'].value = item.purchaseStatus || '';
            DOM.editItemForm['edit-remarks'].value = item.remarks || '';
            openModal(DOM.editItemModal);
        }

        async function setupAddStockFormListener() {
            DOM.addStockForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentlyEditingItemId) return; // Should have the unique ID
                
                const date = DOM.addStockForm['add-stock-date'].value || new Date().toISOString().split('T')[0];
                const quantity = parseInt(DOM.addStockForm['add-stock-quantity'].value, 10);

                if (isNaN(quantity) || quantity <= 0) {
                    showToast('請輸入有效的數量', 'error');
                    return;
                }

                const item = allSupplies.find(s => s.id === currentlyEditingItemId); // Find item by unique ID
                if (item) {
                    const itemRef = doc(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION), item.id); // Use unique ID
                    const newQuantity = item.quantity + quantity;
                    const historyEntry = { date, quantity, type: 'restock' };
                    const updatedHistory = [...(item.inboundHistory || []), historyEntry];

                    await updateDoc(itemRef, {
                        quantity: newQuantity,
                        // Update lastPurchaseDate only if this new date is later? Or always update? Let's always update for simplicity.
                        lastPurchaseDate: date, 
                        inboundHistory: updatedHistory
                    });
                    
                    closeModal(DOM.addStockModal);
                    showToast('入庫成功');
                } else {
                     console.error("Item not found for adding stock:", currentlyEditingItemId);
                     showToast("操作失敗，找不到項目", "error");
                }
            });
        }
        
        async function setupEditFormListener() {
            DOM.editItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentlyEditingItemId) return; // Should have unique ID
                
                const newLastPurchaseDate = DOM.editItemForm['edit-last-purchase-date'].value;
                const newQuantity = parseInt(DOM.editItemForm['edit-quantity'].value, 10);
                const newPurchaseStatus = DOM.editItemForm['edit-purchase-status'].value.trim();
                const newRemarks = DOM.editItemForm['edit-remarks'].value.trim();


                if (isNaN(newQuantity) || newQuantity < 0) { // Also check for negative
                    showToast('請輸入有效的庫存數量 (必須是非負整數)', 'error');
                    return;
                }

                const itemRef = doc(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION), currentlyEditingItemId); // Use unique ID
                await updateDoc(itemRef, {
                    quantity: newQuantity,
                    lastPurchaseDate: newLastPurchaseDate, // Update the date associated with this specific entry
                    purchaseStatus: newPurchaseStatus,
                    remarks: newRemarks
                });
                
                closeModal(DOM.editItemModal);
                showToast('此筆庫存紀錄更新成功');
            });
        }
        
        // --- Unseal History Deletion ---
        function setupUnsealHistoryListener() {
            DOM.unsealHistoryList.addEventListener('click', e => {
                const deleteBtn = e.target.closest('.delete-history-btn');
                if (!deleteBtn) return;

                const { itemId, historyId } = deleteBtn.dataset; // itemId is the unique ID
                const item = allSupplies.find(s => s.id === itemId); // Find by unique ID

                if (!item) {
                    console.error("找不到對應的項目來刪除紀錄");
                    showToast('操作失敗，找不到項目', 'error');
                    return;
                }
                
                // Find the specific history entry
                const historyEntry = (item.usageHistory || []).find(h => h.id === historyId);
                if (!historyEntry) {
                     console.error("找不到對應的歷史紀錄");
                     showToast('操作失敗，找不到紀錄', 'error');
                     return;
                }


                showConfirmation('確認刪除紀錄', `您確定要刪除這筆 "${item.name}" (入庫日期: ${item.lastPurchaseDate || 'N/A'}) 的拆封紀錄嗎？此筆庫存將會加回 1。`, async () => {
                    const itemRef = doc(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION), itemId); // Use unique ID
                    const newQuantity = item.quantity + 1;
                    const newUsageHistory = (item.usageHistory || []).filter(h => h.id !== historyId);

                    try {
                        await updateDoc(itemRef, {
                            quantity: newQuantity,
                            usageHistory: newUsageHistory,
                        });
                        showToast('拆封紀錄已刪除');
                    } catch(err) {
                        console.error("刪除拆封紀錄失敗:", err);
                        showToast('刪除失敗，請稍後再試', 'error');
                    }
                });
            });
        }

        // --- View Toggler ---
        function setView(view) {
            currentView = view;
            localStorage.setItem(CONSTANTS.VIEW_MODE_KEY, view);
            const cardBtn = DOM.viewToggle.querySelector('[data-view="card"]');
            const tableBtn = DOM.viewToggle.querySelector('[data-view="table"]');
            
            cardBtn.classList.toggle('bg-white', view === 'card');
            cardBtn.classList.toggle('shadow-sm', view === 'card');
            cardBtn.classList.toggle('text-indigo-600', view === 'card');
            cardBtn.classList.toggle('text-slate-500', view !== 'card');
            
            tableBtn.classList.toggle('bg-white', view === 'table');
            tableBtn.classList.toggle('shadow-sm', view === 'table');
            tableBtn.classList.toggle('text-indigo-600', view === 'table');
            tableBtn.classList.toggle('text-slate-500', view !== 'table');
        }

        function downloadCSV() {
            const headers = [
                "採購編號", "耗材名稱", "品項", "此筆庫存量", "此筆入庫日期", // Changed Header
                "財編狀態", "備註",
                "入庫紀錄", "拆封紀錄"
            ];

            const sanitizeField = (field) => {
                const str = String(field || '').replace(/"/g, '""');
                return `"${str}"`;
            };

            const rows = allSupplies.map(item => { // Now iterates through individual entries
                const inboundHistory = (item.inboundHistory || [])
                    .map(h => `${h.date}: ${h.quantity}件`)
                    .join('; ');
                // Make sure to extract the date from usageHistory
                const usageHistory = (item.usageHistory || [])
                    .map(h => h.unsealedDate) 
                    .join('; ');
                
                return [
                    sanitizeField(item.purchaseNumber),
                    sanitizeField(item.name),
                    sanitizeField(item.category),
                    item.quantity, // Quantity of this specific entry
                    sanitizeField(item.lastPurchaseDate), // Date of this specific entry
                    sanitizeField(item.purchaseStatus),
                    sanitizeField(item.remarks),
                    sanitizeField(inboundHistory), // This might need refinement if history is per-entry now
                    sanitizeField(usageHistory)  // This might need refinement if history is per-entry now
                ].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `庫存報表_${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('報表已開始下載');
        }

        // --- Firebase Functions ---
        function getCollectionPath(collectionName) {
            const appId = getAppId();
            // Using a public path suitable for shared access on GitHub Pages
            return `artifacts/${appId}/public/data/${collectionName}`; 
        }

        async function addMappingLog(actionMessage) {
            try {
                const logsRef = collection(db, getCollectionPath(CONSTANTS.MAPPING_LOGS_COLLECTION));
                await addDoc(logsRef, {
                    timestamp: new Date().toISOString(),
                    action: actionMessage,
                    user: userId || 'anonymous' // Use the signed-in user ID
                });
            } catch (error) {
                console.error("無法寫入品項日誌:", error);
                // Don't bother the user with a toast for a log failure
            }
        }

        async function seedInitialData() {
            const suppliesRef = collection(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION));
            const q = query(suppliesRef, limit(1));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                console.log("資料庫是空的，正在從CSV植入初始資料...");
                const initialSupplies = getInitialDataFromCSV();
                const batch = writeBatch(db);
                initialSupplies.forEach(item => {
                    // **Use the unique ID generated in getInitialDataFromCSV**
                    const itemRef = doc(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION), item.id); 
                    batch.set(itemRef, item);
                });
                await batch.commit();
                console.log("初始資料植入完成。");
            } else {
                console.log("資料庫已有資料，跳過植入步驟。");
            }
        }
        
        // --- Main Initialization ---
        async function main() {
            // --- Firebase Setup ---
            try {
                /* --- GitHub 發布專用 Firebase 設定 --- */
                const firebaseConfig = {
                    apiKey: "AIzaSyD1Mo73znKs93FiyaXVCnKERAaWzSk_WFY",
                    authDomain: "epson9000-9bcf2.firebaseapp.com",
                    projectId: "epson9000-9bcf2",
                    storageBucket: "epson9000-9bcf2.firebasestorage.app",
                    messagingSenderId: "681687390935",
                    appId: "1:681687390935:web:563c063abd00054fc06e92"
                };
                /* ------------------------------------ */
                
                if (!firebaseConfig.apiKey.startsWith("AIza")) {
                    DOM.loadingState.innerHTML = `<p class="text-red-500">錯誤：請在程式碼中填入您的 Firebase 設定碼。</p>`;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                userId = auth.currentUser.uid;
                
                await seedInitialData();

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                if (error.code === 'auth/configuration-not-found') {
                    DOM.loadingState.innerHTML = `<div class="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-lg text-left max-w-2xl mx-auto">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0">
                                                        <i data-lucide="alert-triangle" class="h-6 w-6 text-amber-600"></i>
                                                    </div>
                                                    <div class="ml-4">
                                                        <h3 class="text-lg font-bold text-amber-800">需要一個重要設定！</h3>
                                                        <p class="text-slate-700 mt-2">您的 Firebase 專案尚未啟用「匿名登入」，這是讓應用程式連接資料庫的必要步驟。</p>
                                                    </div>
                                                </div>
                                                <div class="mt-4">
                                                    <p class="text-slate-600 font-semibold">請依照以下步驟完成設定：</p>
                                                    <ol class="list-decimal list-inside text-slate-600 space-y-2 mt-2 pl-2">
                                                        <li>點擊此連結前往您的 Firebase 專案：<a href="https://console.firebase.google.com/" target="_blank" class="font-semibold text-blue-600 underline hover:text-blue-800">Firebase 控制台</a>。</li>
                                                        <li>在左側選單中，找到並點擊「<b>Authentication</b>」。</li>
                                                        <li>進入 Authentication 後，點擊上方的「<b>Sign-in method</b>」分頁。</li>
                                                        <li>在服務商列表中找到「<b>匿名</b>」，點擊它並將開關設定為「<b>啟用</b>」，然後儲存。</li>
                                                        <li>完成後，回到此頁面並<b>重新整理</b>。</li>
                                                    </ol>
                                                    <p class="mt-4 text-xs text-slate-500">這不是程式碼的錯誤，而是一個必須在 Firebase 網站上完成的專案設定。</p>
                                                </div>
                                            </div>`;
                    lucide.createIcons();
                } else {
                    DOM.loadingState.innerHTML = `<p class="text-red-500">錯誤：無法連接到資料庫。請確認 Firebase 設定是否正確。</p>`;
                }
                return; // Stop execution if there's an error
            }

            // --- UI and Listeners Setup ---
            setView(currentView);
            lucide.createIcons();
            
            // Listen for real-time updates
            const suppliesQuery = collection(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION));
            onSnapshot(suppliesQuery, (snapshot) => {
                allSupplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Store unique ID from Firestore
                renderInventory();
                renderUnsealHistory();
            }, (error) => {
                console.error("讀取庫存資料時發生錯誤:", error);
                showToast('讀取庫存資料失敗，請稍後再試', 'error');
                // Optionally display a more prominent error message on the page
                DOM.inventoryList.innerHTML = `<p class="text-red-500 text-center">無法載入庫存資料。</p>`;
            });

            initializeAndLoadMappings(); // This now loads CSV defaults first, then listens for Firestore
            listenToMappingLogs(); // Listen to logs on page load
            
            // --- EVENT LISTENERS ---
            DOM.viewToggle.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if(button) {
                    const view = button.dataset.view;
                    setView(view);
                    renderInventory();
                }
            });

            DOM.manageMappingsBtn.addEventListener('click', () => {
                openModal(DOM.mappingsModal);
                // No need to start log listener here anymore
            });
            DOM.closeMappingsModalBtn.addEventListener('click', () => closeModal(DOM.mappingsModal));
            DOM.mappingsModal.addEventListener('click', (e) => { 
                if (e.target === DOM.mappingsModal) closeModal(DOM.mappingsModal); 
            });
            
            DOM.closeAddStockModalBtn.addEventListener('click', () => closeModal(DOM.addStockModal));
            DOM.addStockModal.addEventListener('click', (e) => { if (e.target === DOM.addStockModal) closeModal(DOM.addStockModal); });

            DOM.closeEditModalBtn.addEventListener('click', () => closeModal(DOM.editItemModal));
            DOM.editItemModal.addEventListener('click', (e) => { if (e.target === DOM.editItemModal) closeModal(DOM.editItemModal); });
            
            DOM.addCategoryBtn.addEventListener('click', async () => {
                const newCategory = prompt('請輸入新的耗材類別(品項)名稱：');
                if (newCategory && newCategory.trim() !== '') {
                    const trimmedCategory = newCategory.trim();
                    await saveCustomCategory(trimmedCategory);
                     // Set the newly added category in the dropdown in the mapping modal
                     DOM.newItemCategorySelect.value = trimmedCategory; 
                    showToast(`類別 "${trimmedCategory}" 已新增`);
                }
            });

            DOM.downloadCsvBtn.addEventListener('click', downloadCSV);

            DOM.purchaseNumberInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                const feedbackEl = DOM.purchaseNumberFeedback;
                const resultsContainer = DOM.purchaseNumberResults;

                resultsContainer.innerHTML = '';
                feedbackEl.textContent = '';
                
                 // Clear derived fields when input changes
                 DOM.itemNameInput.value = '';
                 DOM.categorySelect.value = '';
                 DOM.categorySelect.disabled = true;
                 DOM.categorySelect.classList.add('bg-slate-50');

                if (!searchTerm) {
                    resultsContainer.classList.add('hidden');
                    return;
                }

                const results = Object.entries(purchaseNumberMap).filter(([key, value]) => {
                    // Make sure value exists and has properties before accessing them
                    return value && (
                         key.toLowerCase().includes(searchTerm) || 
                         (value.name && value.name.toLowerCase().includes(searchTerm)) ||
                         (value.category && value.category.toLowerCase().includes(searchTerm))
                    );
                });


                if (results.length > 0) {
                    results.forEach(([key, value]) => {
                        const resultEl = document.createElement('div');
                        resultEl.className = 'p-2 hover:bg-indigo-100 cursor-pointer';
                        resultEl.innerHTML = `<p class="font-semibold text-slate-800">${value.name || 'N/A'}</p><p class="text-sm text-slate-500">${key}</p>`;
                        resultEl.dataset.key = key;
                        resultsContainer.appendChild(resultEl);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.classList.add('hidden');
                    feedbackEl.textContent = '查無編號，請新增';
                }
            });

            DOM.purchaseNumberResults.addEventListener('click', (e) => {
                const resultEl = e.target.closest('[data-key]');
                if (resultEl) {
                    const key = resultEl.dataset.key;
                    const item = purchaseNumberMap[key];
                    
                    if (item) { // Ensure item exists in the map
                        DOM.purchaseNumberInput.value = key;
                        DOM.itemNameInput.value = item.name;
                        addCategoryOption(item.category, true); // This will enable and set the category dropdown

                        DOM.purchaseNumberResults.classList.add('hidden');
                        DOM.purchaseNumberFeedback.textContent = '';
                    } else {
                        console.error("Selected item not found in purchaseNumberMap:", key);
                        showToast('選擇品項時發生錯誤', 'error');
                    }
                }
            });


            document.addEventListener('click', (e) => {
                if (!DOM.purchaseNumberInput.contains(e.target) && !DOM.purchaseNumberResults.contains(e.target)) {
                    DOM.purchaseNumberResults.classList.add('hidden');
                }
            });

            DOM.addMappingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const number = document.getElementById('new-purchase-number').value.trim();
                const name = document.getElementById('new-item-name').value.trim();
                const category = DOM.newItemCategorySelect.value;
                if (!number || !name || !category) {
                     showToast('請填寫所有欄位', 'error');
                     return;
                 }
                
                // Prevent overwriting if not in edit mode and key already exists? Optional.
                // if (!editingKey && purchaseNumberMap[number]) {
                //     showToast(`採購編號 "${number}" 已存在`, 'error');
                //     return;
                // }

                const oldData = (editingKey && purchaseNumberMap[editingKey]) ? 
                                ` (原: ${purchaseNumberMap[editingKey].name}, ${purchaseNumberMap[editingKey].category})` : '';

                if (editingKey && editingKey !== number) {
                     // If the key (purchase number) is changed during edit, delete the old one first
                     const oldDocRef = doc(db, getCollectionPath(CONSTANTS.MAPPINGS_COLLECTION), editingKey);
                     try {
                         await deleteDoc(oldDocRef);
                         // Don't log deletion here, log it as part of the edit
                     } catch (err) {
                         console.warn("Could not delete old mapping doc:", editingKey, err);
                         // Proceed with adding the new one anyway? Or show error?
                         // Let's proceed but maybe log it more prominently.
                     }
                }

                const docRef = doc(db, getCollectionPath(CONSTANTS.MAPPINGS_COLLECTION), number);
                try {
                    await setDoc(docRef, { name, category });
                    // Set a flag to highlight this key when list re-renders
                    window.lastEditedMappingKey = number;

                    if (editingKey) {
                        // Log edit
                        await addMappingLog(`編輯品項: ${number} (新: ${name}, ${category})${oldData}`);
                        cancelEditMode();
                    } else {
                        // Log add
                        await addMappingLog(`新增品項: ${number} (${name}, ${category})`);
                        DOM.addMappingForm.reset();
                    }
                    showToast('品項儲存成功！');

                } catch (error) {
                    console.error("儲存品項對照時發生錯誤:", error);
                    showToast('儲存品項失敗', 'error');
                }
            });


            DOM.mappingsListContainer.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-mapping-btn');
                const deleteButton = e.target.closest('.delete-mapping-btn');

                if (editButton) {
                    const key = editButton.dataset.key;
                    startEditMode(key);
                } else if (deleteButton) {
                    const key = deleteButton.dataset.key;
                    const item = purchaseNumberMap[key]; // Get item details before deleting
                    const itemDetails = item ? `(${item.name}, ${item.category})` : '';
                         showConfirmation(
                             '確認刪除',
                             `您確定要刪除品項 "${key}" 嗎？這不會刪除已存在的庫存項目，只會從對照表中移除。`, // Clarify deletion scope
                             async () => {
                                 const docRef = doc(db, getCollectionPath(CONSTANTS.MAPPINGS_COLLECTION), key);
                                 try {
                                     await deleteDoc(docRef);
                                     // Log delete
                                     await addMappingLog(`刪除品項: ${key} ${itemDetails}`);
                                     showToast('品項已刪除');
                                     // If the deleted item was being edited, cancel edit mode
                                     if (editingKey === key) {
                                         cancelEditMode();
                                     }
                                 } catch (error) {
                                     console.error("刪除品項對照時發生錯誤:", error);
                                     showToast('刪除品項失敗', 'error');
                                 }
                             }
                         );
                }
            });
            
            // This function is defined below in setup file
            setupFormListener();
            setupAddStockFormListener();
            setupEditFormListener();
            setupUnsealHistoryListener();
        }

        async function setupFormListener() {
            document.getElementById('add-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const purchaseNumber = DOM.purchaseNumberInput.value.trim();
                if (!purchaseNumber) {
                    showToast('請先選擇或輸入一個有效的採購編號', 'error');
                    DOM.purchaseNumberFeedback.textContent = '此欄位為必填項';
                    return;
                }

                const name = DOM.itemNameInput.value.trim();
                 // Check if name was derived from selection, if not, maybe error?
                 if (!name) {
                     showToast('無法自動帶入耗材名稱，請確認採購編號是否正確或已在品項管理中建立', 'error');
                     return;
                 }


                // Ensure category is selected or derived correctly
                const category = DOM.categorySelect.value;
                 if (!category) {
                     showToast('請選擇耗材類別', 'error');
                     return;
                 }


                const quantityInput = document.getElementById('item-quantity');
                const quantity = parseInt(quantityInput.value, 10);
                 // **Allow 0 quantity for adding an entry without initial stock? Let's require at least 1 for initial add.**
                 if (isNaN(quantity) || quantity <= 0) { 
                     showToast('請輸入有效的入庫數量 (必須是正整數)', 'error'); // Changed message
                     quantityInput.focus(); // Highlight the input field
                     return;
                 }


                const purchaseDate = DOM.itemPurchaseDate.value;
                const remarks = document.getElementById('item-remarks').value.trim();

                // **CHANGE: Always add a new item**
                try {
                    const currentDate = new Date().toISOString().split('T')[0]; // Get current date for defaults
                    const finalPurchaseDate = purchaseDate || currentDate; // Use provided date or default to today
                    const uniqueItemId = crypto.randomUUID(); // Generate unique ID for this new entry

                    // Create the new item object
                    const newItem = {
                        id: uniqueItemId, // Store the unique ID within the document as well
                        purchaseNumber,
                        name,
                        category,
                        quantity,
                        lastPurchaseDate: finalPurchaseDate, // Represents the date this specific batch was added
                        purchaseStatus: '', // Default empty status for new entries
                        remarks: remarks, // Remarks specific to this entry/batch
                        usageHistory: [], // Initialize as empty array
                        inboundHistory: [{ date: finalPurchaseDate, quantity, type: 'initial_add' }], 
                    };

                    // Use setDoc with the unique ID
                    const itemRef = doc(db, getCollectionPath(CONSTANTS.SUPPLIES_COLLECTION), uniqueItemId);
                    await setDoc(itemRef, newItem);
                    showToast(`"${name}" (入庫日期: ${finalPurchaseDate}) 已成功新增至庫存`);

                    // Reset the form after successful addition
                    document.getElementById('add-item-form').reset();
                    // Clear fields derived from lookup and disable category again
                     DOM.itemNameInput.value = '';
                     DOM.categorySelect.value = '';
                     DOM.categorySelect.disabled = true;
                     DOM.categorySelect.classList.add('bg-slate-50');
                     DOM.purchaseNumberFeedback.textContent = '';


                } catch (error) {
                    console.error("儲存新庫存項目時發生錯誤:", error);
                    showToast('新增失敗，請稍後再試', 'error');
                }
            });
        }

        main();
    </script>
</body>
</html>

