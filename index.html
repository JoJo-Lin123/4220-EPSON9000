<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>庫存管理系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .btn-action {
            transition: transform 0.1s ease-in-out, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .btn-action:hover:not(:disabled) {
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .btn-action:active:not(:disabled) {
            transform: scale(0.95);
        }
        .btn-action:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(50%) sepia(10%) saturate(200%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        .table-striped tbody tr:nth-child(odd) { background-color: #f9fafb; }
        .table-striped tbody tr:hover { background-color: #f1f5f9; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        @keyframes toast-in {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        .toast.show { animation: toast-in 0.3s ease-out forwards; }
        .toast.hide { animation: toast-out 0.3s ease-in forwards; }
    </style>
</head>
<body class="min-h-screen antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- 應用程式標題 -->
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-bold text-slate-800 flex justify-center items-center">
                <i data-lucide="package-search" class="w-10 h-10 mr-4 text-indigo-600"></i>庫存管理系統
            </h1>
        </header>

        <!-- 新增耗材表單 -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-10">
            <div class="flex justify-between items-center mb-5 border-b border-slate-200 pb-4">
                <h2 class="text-xl font-semibold text-slate-700 flex items-center">
                    <i data-lucide="plus-circle" class="mr-2 text-indigo-500"></i>新增耗材
                </h2>
                <div class="flex items-center space-x-2">
                    <button id="download-csv-btn" class="text-sm bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors flex items-center">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>下載庫存報表
                    </button>
                    <button id="manage-mappings-btn" class="text-sm bg-slate-100 text-slate-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition-colors flex items-center">
                        <i data-lucide="settings-2" class="w-4 h-4 mr-2"></i>管理品項
                    </button>
                </div>
            </div>
            <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="relative">
                    <label for="item-purchase-number" class="block text-sm font-medium text-slate-600 mb-1">採購編號 (可搜尋關鍵字)</label>
                    <input type="text" id="item-purchase-number" placeholder="輸入編號或名稱關鍵字" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" autocomplete="off">
                    <div id="purchase-number-feedback" class="text-sm text-red-500 mt-1 h-4"></div>
                    <div id="purchase-number-results" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-60 overflow-y-auto hidden shadow-lg custom-scrollbar"></div>
                </div>
                <div>
                    <label for="item-name" class="block text-sm font-medium text-slate-600 mb-1">耗材名稱</label>
                    <input type="text" id="item-name" placeholder="將自動帶入" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition bg-slate-50" readonly>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <label for="item-category" class="block text-sm font-medium text-slate-600 mb-1">耗材類別</label>
                        <button type="button" id="add-category-btn" class="text-indigo-600 hover:text-indigo-800 font-bold mb-1 rounded-full w-6 h-6 flex items-center justify-center bg-indigo-100 hover:bg-indigo-200 transition-colors" title="新增類別">+</button>
                    </div>
                    <select id="item-category" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition bg-slate-50" disabled>
                        <option value="" disabled selected>將自動帶入</option>
                    </select>
                </div>
                <div>
                    <label for="item-purchase-date" class="block text-sm font-medium text-slate-600 mb-1">進貨日期</label>
                    <input type="date" id="item-purchase-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div class="md:col-span-2">
                    <label for="item-quantity" class="block text-sm font-medium text-slate-600 mb-1">目前庫存</label>
                    <input type="number" id="item-quantity" value="1" min="0" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors btn-action flex items-center justify-center">
                         <i data-lucide="plus" class="w-5 h-5 mr-2"></i> 新增至庫存
                    </button>
                </div>
            </form>
        </div>

        <!-- 庫存清單 -->
        <div id="inventory-container">
             <div id="loading-state" class="text-center py-10">
                <div class="flex justify-center items-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-slate-500">正在載入資料...</p>
                </div>
            </div>
            <!-- 庫存總覽 -->
            <div id="inventory-list-section" class="hidden">
                 <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">庫存總覽</h2>
                    <div id="view-toggle" class="flex items-center rounded-lg bg-slate-200 p-1 self-start sm:self-center">
                        <button data-view="card" class="p-2 rounded-md transition-colors" title="卡片視圖"><i data-lucide="layout-grid" class="w-5 h-5 pointer-events-none"></i></button>
                        <button data-view="table" class="p-2 rounded-md transition-colors" title="表格視圖"><i data-lucide="list" class="w-5 h-5 pointer-events-none"></i></button>
                    </div>
                </div>
                <div id="inventory-list" class="space-y-4"></div>
            </div>

            <!-- 拆封紀錄 -->
            <div id="unseal-history-section" class="mt-12 hidden">
                <h3 class="text-xl font-semibold text-slate-700 mb-4 border-b-2 border-slate-200 pb-2 flex items-center">
                    <i data-lucide="history" class="mr-3 text-slate-500"></i>最近拆封紀錄
                </h3>
                <div id="unseal-history-list" class="space-y-2 bg-white p-4 rounded-xl shadow-md">
                    <!-- History items will be injected here -->
                </div>
            </div>

        </div>
    </div>
    
    <!-- Modals -->
    <div id="mappings-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white w-full max-w-2xl p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800">管理品項對照表</h3>
                <button id="close-mappings-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="mb-6 bg-slate-50 p-4 rounded-lg">
                <h4 id="mapping-form-title" class="font-semibold text-slate-700 mb-2">新增對照品項</h4>
                <form id="add-mapping-form" class="space-y-3">
                    <div>
                        <label for="new-purchase-number" class="text-sm font-medium text-slate-600">採購編號</label>
                        <input type="text" id="new-purchase-number" placeholder="請輸入採購編號" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="new-item-name" class="text-sm font-medium text-slate-600">耗材名稱</label>
                        <input type="text" id="new-item-name" placeholder="請輸入對應的耗材名稱" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="new-item-category" class="text-sm font-medium text-slate-600">耗材類別 (品項)</label>
                        <select id="new-item-category" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition bg-white"></select>
                    </div>
                    <div id="mapping-form-buttons" class="!mt-4 space-y-2">
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn-action">儲存品項</button>
                    </div>
                </form>
            </div>
            <div id="mappings-list-container" class="max-h-80 overflow-y-auto space-y-4 pr-2 custom-scrollbar"></div>
        </div>
    </div>

    <div id="add-stock-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
         <div class="modal-content bg-white w-full max-w-md p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800">添加入庫紀錄</h3>
                <button id="close-add-stock-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="add-stock-form" class="space-y-4">
                <div>
                    <label for="add-stock-date" class="block text-sm font-medium text-slate-600 mb-1">入庫日期</label>
                    <input type="date" id="add-stock-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <div>
                    <label for="add-stock-quantity" class="block text-sm font-medium text-slate-600 mb-1">入庫數量</label>
                    <input type="number" id="add-stock-quantity" min="1" value="1" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <div class="!mt-6">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn-action">確認入庫</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-item-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
         <div class="modal-content bg-white w-full max-w-md p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800">編輯庫存項目</h3>
                <button id="close-edit-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="edit-item-form" class="space-y-4">
                <div>
                    <label for="edit-last-purchase-date" class="block text-sm font-medium text-slate-600 mb-1">最近入庫日期</label>
                    <input type="date" id="edit-last-purchase-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <div>
                    <label for="edit-quantity" class="block text-sm font-medium text-slate-600 mb-1">總庫存</label>
                    <input type="number" id="edit-quantity" min="0" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <div class="!mt-6">
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors btn-action">更新庫存</button>
                </div>
            </form>
        </div>
    </div>

     <div id="confirmation-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content bg-white w-full max-w-sm p-6 rounded-2xl shadow-lg opacity-0 transform -translate-y-10 text-center">
             <div id="confirmation-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
            </div>
            <h3 id="confirmation-title" class="text-lg font-semibold text-slate-800 mb-2"></h3>
            <p id="confirmation-message" class="text-slate-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-confirmation-btn" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
                <button id="confirm-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">確認</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100]"></div>
    
    <script>
        const appId = 'default-app-id';
        
        // --- CONSTANTS ---
        const CONSTANTS = {
            MAPPINGS_KEY: `inventory_app_mappings_${appId}`,
            CUSTOM_CATEGORIES_KEY: `inventory_app_custom_categories_${appId}`,
            VIEW_MODE_KEY: `inventory_view_${appId}`,
            DATA_KEY: `inventory_app_data_${appId}`,
            INK_LOW_STOCK_THRESHOLD: 2,
            OTHER_LOW_STOCK_THRESHOLD: 3,
        };
        
        // --- DOM Elements ---
        const DOM = {
            inventoryContainer: document.getElementById('inventory-container'),
            loadingState: document.getElementById('loading-state'),
            inventoryList: document.getElementById('inventory-list'),
            inventoryListSection: document.getElementById('inventory-list-section'),
            purchaseNumberInput: document.getElementById('item-purchase-number'),
            itemNameInput: document.getElementById('item-name'),
            categorySelect: document.getElementById('item-category'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            itemPurchaseDate: document.getElementById('item-purchase-date'),
            manageMappingsBtn: document.getElementById('manage-mappings-btn'),
            mappingsModal: document.getElementById('mappings-modal'),
            closeMappingsModalBtn: document.getElementById('close-mappings-modal-btn'),
            addMappingForm: document.getElementById('add-mapping-form'),
            mappingsListContainer: document.getElementById('mappings-list-container'),
            newItemCategorySelect: document.getElementById('new-item-category'),
            purchaseNumberFeedback: document.getElementById('purchase-number-feedback'),
            purchaseNumberResults: document.getElementById('purchase-number-results'),
            mappingFormTitle: document.getElementById('mapping-form-title'),
            mappingFormButtons: document.getElementById('mapping-form-buttons'),
            viewToggle: document.getElementById('view-toggle'),
            addStockModal: document.getElementById('add-stock-modal'),
            closeAddStockModalBtn: document.getElementById('close-add-stock-modal-btn'),
            addStockForm: document.getElementById('add-stock-form'),
            editItemModal: document.getElementById('edit-item-modal'),
            closeEditModalBtn: document.getElementById('close-edit-modal-btn'),
            editItemForm: document.getElementById('edit-item-form'),
            confirmationModal: document.getElementById('confirmation-modal'),
            unsealHistorySection: document.getElementById('unseal-history-section'),
            unsealHistoryList: document.getElementById('unseal-history-list'),
            downloadCsvBtn: document.getElementById('download-csv-btn'),
        };

        // --- State ---
        let purchaseNumberMap = {};
        let allSupplies = [];
        let editingKey = null;
        let currentView = localStorage.getItem(CONSTANTS.VIEW_MODE_KEY) || 'card';
        let currentlyEditingItemId = null;

        // --- Initial Data ---
        const initialPurchaseNumberMap = {
            '94-618-PIFB2006050-36': { name: '防水絹布(薄油畫布)60” (切工36”+24”,50米)', category: '90薄布' },
            '94-618-PIFB2006050-44': { name: '防水絹布(薄油畫布)60” (切工44”+16”,50米)', category: '110薄布' },
            '94-620-PIFO30036': { name: '藝術 防水霧面油畫布36吋30米(台製)', category: '90厚布' },
            '94-620-PIFO30044': { name: '藝術 防水霧面油畫布44吋30米(台製)', category: '110厚布' },
            '94-620-PIBA11036': { name: '防水INKJET海報紙110磅36”(45米)', category: '90海報紙' },
            '94-620-PIBA11044': { name: '防水INKJET海報紙110磅44”(45米)', category: '110海報紙' },
            '94-618-PIBA17036': { name: '防水噴墨厚卡海報紙170磅30米36”', category: '90專用紙(新材編)' },
            '94-620-S041224': { name: 'EPSON 9000 滾筒紙44”*25M 台製<薄專用紙>', category: '110專用紙' },
            '94-620-PIAA13536': { name: '防水噴墨銅版打樣紙135磅30米36吋', category: '90銅板打樣紙' },
            '94-620-PIAF170T36': { name: '背膠超光亮面相紙170磅18米36吋', category: '90背膠亮面相紙' },
            '94-620-PID200ST36': { name: '防水PVC自黏白霧面200磅30米36吋(貼紙)', category: '90自黏白霧面' },
            '94-618-S041391': { name: 'EPSON 頂級光面相紙36”*30.5m S041391<原廠170磅>', category: '90原廠相紙' },
            '94-618-S041640': { name: 'EPSON 頂級光面相紙44”*30.5m S041640<原廠250磅>', category: '110原廠相紙' },
            '94-618-T804100': { name: 'EPSON SCP9000亮光黑色墨水匣PK/700ML', category: 'T8041亮光黑/PK' },
            '94-618-T804200': { name: 'EPSON SCP9000藍色墨水匣C/700ML', category: 'T8042藍色/C' },
            '94-618-T804300': { name: 'EPSON SCP9000靚紅色墨水匣VM/700ML', category: 'T55K3靚紅色/VM' },
            '94-618-T804400': { name: 'EPSON SCP9000黃色墨水匣Y/700ML', category: 'T8044黃色/Y' },
            '94-618-T804500': { name: 'EPSON SCP9000淡藍色墨水匣LC/700ML', category: 'T55K5淡藍色/LC' },
            '94-618-T804600': { name: 'EPSON SCP9000淡靚紅色墨水匣VLM/700ML', category: 'T55K6淡靚紅色/VLM' },
            '94-618-T804700': { name: 'EPSON SCP9000淡黑色墨水匣LK/700ML', category: 'T55K7淡黑色/LK' },
            '94-618-T804800': { name: 'EPSON SCP9000消光黑色墨水匣MK/700ML', category: 'T8048消光黑MK' },
            '94-618-T804900': { name: 'EPSON SCP9000超淡黑色墨水匣LLK/700ML', category: 'T55K9超淡黑/LLK' },
            '94-618-T804A00': { name: 'EPSON SCP9000橘色墨水匣OR/700ML', category: 'T804A橘色/OR' },
            '94-618-T804B00': { name: 'EPSON SCP9000綠色墨水匣GR/700ML', category: 'T804B綠色/GR' },
            '94-620-C811241': { name: 'EPSON SCP9000捲筒配接器', category: '捲筒配接器' },
            '94-618-T699700': { name: 'EPSON SCP9000廢墨盒', category: '墨水收集槽' },
        };

        const majorCategoryMap = {
            '90薄布': '滾筒布', '110薄布': '滾筒布', '90厚布': '滾筒布', '110厚布': '滾筒布',
            '90海報紙': '滾筒紙', '110海報紙': '滾筒紙', '90專用紙': '滾筒紙', '90專用紙(新材編)': '滾筒紙', '110專用紙': '滾筒紙', '90銅板打樣紙': '滾筒紙', '90背膠亮面相紙': '滾筒紙', '90自黏白霧面': '滾筒紙', '90原廠相紙': '滾筒紙', '110原廠相紙': '滾筒紙',
            'T8041亮光黑/PK': '墨水匣', 'T8042藍色/C': '墨水匣', 'T55K3靚紅色/VM': '墨水匣', 'T8044黃色/Y': '墨水匣', 'T55K5淡藍色/LC': '墨水匣', 'T55K6淡靚紅色/VLM': '墨水匣', 'T55K7淡黑色/LK': '墨水匣', 'T8048消光黑MK': '墨水匣', 'T55K9超淡黑/LLK': '墨水匣', 'T804A橘色/OR': '墨水匣', 'T804B綠色/GR': '墨水匣',
            '捲筒配接器': '其他', '墨水收集槽': '其他'
        };

        /**
         * 顯示 Toast 通知
         * @param {string} message - 要顯示的訊息
         * @param {'success'|'error'} type - 通知類型
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' 
                ? `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>` 
                : `<i data-lucide="x-circle" class="w-5 h-5 text-red-500"></i>`;
            
            toast.className = `toast flex items-center gap-3 bg-white shadow-2xl rounded-lg py-3 px-4 mb-2 transition-transform duration-300`;
            toast.innerHTML = `${icon}<p class="font-semibold text-slate-700">${message}</p>`;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.add('hide');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        function saveData() {
            localStorage.setItem(CONSTANTS.DATA_KEY, JSON.stringify(allSupplies));
        }

        function loadData() {
            let data = JSON.parse(localStorage.getItem(CONSTANTS.DATA_KEY));
            
            const suppliesMap = new Map(data ? data.map(item => [item.purchaseNumber.trim(), item]) : []);

            const comprehensiveList = Object.entries(purchaseNumberMap).map(([purchaseNumber, details]) => {
                const trimmedPurchaseNumber = purchaseNumber.trim();
                const dbItem = suppliesMap.get(trimmedPurchaseNumber);
                if (dbItem) {
                    suppliesMap.delete(trimmedPurchaseNumber);
                    return dbItem;
                } else {
                    return {
                        id: `placeholder-${trimmedPurchaseNumber}`,
                        purchaseNumber: trimmedPurchaseNumber,
                        name: details.name,
                        category: details.category,
                        quantity: 0,
                        lastPurchaseDate: '---',
                        usageHistory: [],
                        inboundHistory: []
                    };
                }
            });

            allSupplies = [...comprehensiveList, ...Array.from(suppliesMap.values())];
            DOM.loadingState.style.display = 'none';
            renderInventory();
            renderUnsealHistory();
        }

        function setupFormListener() {
            const form = document.getElementById('add-item-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const { value: category } = DOM.categorySelect;
                const { value: name } = DOM.itemNameInput;
                const purchaseNumber = DOM.purchaseNumberInput.value.trim();
                const purchaseDate = DOM.itemPurchaseDate.value || new Date().toISOString().split('T')[0];
                const quantity = parseInt(document.getElementById('item-quantity').value, 10);
                if (!category || !name || !purchaseNumber || isNaN(quantity)) return;

                const existingItem = allSupplies.find(item => item.purchaseNumber === purchaseNumber);

                if (existingItem) {
                    existingItem.quantity += quantity;
                    if (!existingItem.inboundHistory) existingItem.inboundHistory = [];
                    existingItem.inboundHistory.push({ date: purchaseDate, quantity, type: 'restock' });
                    existingItem.lastPurchaseDate = purchaseDate;
                    if(existingItem.id.startsWith('placeholder-')){
                        existingItem.id = `item-${Date.now()}`;
                    }
                     showToast('庫存已成功疊加！');
                } else {
                    const newItem = {
                        id: `item-${Date.now()}`,
                        purchaseNumber,
                        name,
                        category,
                        quantity,
                        lastPurchaseDate: purchaseDate,
                        usageHistory: [],
                        inboundHistory: [{ date: purchaseDate, quantity, type: 'initial' }],
                        createdAt: new Date().toISOString()
                    };
                    allSupplies.push(newItem);
                    showToast('耗材新增成功！');
                }

                saveData();
                renderInventory();
                renderUnsealHistory();
                form.reset();
                DOM.purchaseNumberFeedback.textContent = '';
            });
        }
        
        function renderInventory() {
            DOM.inventoryListSection.style.display = 'block';
            const mainListContainer = DOM.inventoryList;

            mainListContainer.innerHTML = '';
            mainListContainer.className = 'space-y-8';

            const groupedAllItems = allSupplies.reduce((acc, item) => {
                const majorCat = majorCategoryMap[item.category] || '其他';
                if (!acc[majorCat]) acc[majorCat] = [];
                acc[majorCat].push(item);
                return acc;
            }, {});

            const categoryOrder = ['滾筒布', '滾筒紙', '墨水匣', '其他'];
            const categoryIcons = { '滾筒布': 'layers', '滾筒紙': 'file-stack', '墨水匣': 'droplets', '其他': 'package' };

            if (allSupplies.length > 0) {
                categoryOrder.forEach(majorCat => {
                    if (groupedAllItems[majorCat] && groupedAllItems[majorCat].length > 0) {
                        const groupContainer = document.createElement('div');
                        groupContainer.innerHTML = `
                            <h3 class="text-lg font-semibold text-slate-700 mb-3 border-b pb-2 flex items-center">
                                <i data-lucide="${categoryIcons[majorCat]}" class="w-5 h-5 mr-2 text-slate-500"></i>
                                ${majorCat}
                            </h3>`;
                        
                        const subListContainer = document.createElement('div');
                        renderGroup(subListContainer, groupedAllItems[majorCat]);
                        groupContainer.appendChild(subListContainer);
                        mainListContainer.appendChild(groupContainer);
                    }
                });
            } else {
                 mainListContainer.innerHTML = `<div class="text-center py-10 bg-slate-50 rounded-lg"><i data-lucide="inbox" class="mx-auto h-12 w-12 text-slate-400"></i><h3 class="mt-2 text-sm font-medium text-slate-900">沒有任何項目</h3><p class="mt-1 text-sm text-slate-500">請先新增耗材或管理品項。</p></div>`;
            }

            lucide.createIcons();
        }


        function renderGroup(container, items) {
            if (items.length === 0) return;
            
             if (currentView === 'card') {
                container.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4';
                items.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(item => {
                    container.appendChild(createItemCard(item));
                });
            } else {
                container.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                const tableHTML = `
                    <table class="w-full text-sm text-left text-slate-500 table-striped">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-4 py-3">耗材名稱</th>
                                <th scope="col" class="px-4 py-3">採購編號</th>
                                <th scope="col" class="px-4 py-3">最近入庫</th>
                                <th scope="col" class="px-4 py-3">紀錄</th>
                                <th scope="col" class="px-4 py-3 text-center">庫存</th>
                                <th scope="col" class="px-4 py-3 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).map(createItemTableRow).join('')}
                        </tbody>
                    </table>`;
                container.innerHTML = tableHTML;
                addTableEventListeners(container);
            }
        }

        function createItemCard(item) {
            const itemCard = document.createElement('div');
            const isPlaceholder = item.id.startsWith('placeholder-');
            
            const isInk = (majorCategoryMap[item.category] || '其他') === '墨水匣';
            const threshold = isInk ? CONSTANTS.INK_LOW_STOCK_THRESHOLD : CONSTANTS.OTHER_LOW_STOCK_THRESHOLD;
            const isLowStock = item.quantity < threshold && item.quantity > 0;
            const isZero = item.quantity === 0;

            let cardClasses = 'bg-white rounded-lg shadow p-4 flex flex-col justify-between transition-all hover:shadow-lg hover:-translate-y-1 relative overflow-hidden';
            if (isPlaceholder) {
                cardClasses += ' bg-slate-50';
            }
            if (isZero) {
                 cardClasses += ' border-2 border-red-400 ring-4 ring-red-100/50';
            } else if (isLowStock) {
                cardClasses += ' border-2 border-amber-400 ring-4 ring-amber-100/50';
            }
            
            const historyHtml = `
                <div class="mt-2 pt-2 border-t border-slate-200 space-y-2">
                    ${(item.inboundHistory && item.inboundHistory.length > 0) ? `
                    <div>
                        <p class="text-xs font-medium text-slate-600 flex items-center"><i data-lucide="log-in" class="w-3 h-3 mr-1.5"></i>入庫紀錄:</p>
                        <ul class="text-xs text-slate-500 mt-1 pl-5 list-disc">${item.inboundHistory.slice(-3).map(h => `<li>${h.date}: ${h.quantity}件</li>`).join('')}</ul>
                    </div>` : ''}
                    ${(item.usageHistory && item.usageHistory.length > 0) ? `
                    <div>
                        <p class="text-xs font-medium text-slate-600 flex items-center"><i data-lucide="log-out" class="w-3 h-3 mr-1.5"></i>拆封紀錄:</p>
                        <ul class="text-xs text-slate-500 mt-1 pl-5 list-disc">${item.usageHistory.slice(-3).map(h => `<li>${h.unsealedDate}</li>`).join('')}</ul>
                    </div>` : ''}
                </div>`;
            
            let purchaseAlertHtml = '';
            if (isZero) {
                purchaseAlertHtml = `<div class="mb-3 flex items-center p-2 rounded-md bg-red-100 text-red-800 text-sm font-bold">
                     <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>
                     <span>庫存已歸零 (建議庫存: ${threshold})</span>
                   </div>`;
            } else if (isLowStock) {
                 purchaseAlertHtml = `<div class="mb-3 flex items-center p-2 rounded-md bg-amber-100 text-amber-800 text-sm font-bold">
                     <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                     <span>請盡快採購 (建議庫存: ${threshold})</span>
                   </div>`;
            }


            const actionButtonsHtml = !isPlaceholder ? `
                <div class="flex items-center justify-between mt-4 pt-3 border-t">
                    <div class="flex items-center space-x-2">
                        <button data-action="decrease" class="btn-action bg-slate-200 text-slate-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-300 text-lg font-bold" ${item.quantity <= 0 ? 'disabled' : ''}>-</button>
                        <span data-role="quantity-display" class="font-bold text-xl text-slate-800 w-10 text-center">${item.quantity}</span>
                        <button data-action="increase" class="btn-action bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-green-200 text-lg font-bold">+</button>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button data-action="unseal" class="btn-action bg-blue-100 text-blue-600 rounded-md h-8 px-3 flex items-center justify-center hover:bg-blue-200 text-xs font-semibold" ${item.quantity <= 0 ? 'disabled' : ''}>拆封</button>
                        <button data-action="edit" class="btn-action text-slate-500 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-200 hover:text-indigo-600"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button data-action="delete" class="btn-action text-slate-500 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-200 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            ` : `
                <div class="flex items-center justify-end mt-4 pt-3 border-t">
                    <div class="text-right">
                        <p class="text-xs text-slate-500">現有庫存</p>
                        <span data-role="quantity-display" class="font-bold text-xl text-slate-800">${item.quantity}</span>
                    </div>
                </div>
            `;

            itemCard.className = cardClasses;
            itemCard.dataset.itemId = item.id;
            itemCard.innerHTML = `
                <div>
                    ${purchaseAlertHtml}
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex-1 pr-2">${item.name}</h3>
                        <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-100 flex-shrink-0">${item.category || '未分類'}</span>
                    </div>
                    <p class="text-xs text-slate-500">採購編號: <span class="font-medium text-slate-600">${item.purchaseNumber || 'N/A'}</span></p>
                    <p class="text-xs text-slate-500">最近入庫: <span class="font-medium text-slate-600">${item.lastPurchaseDate || '---'}</span></p>
                    ${historyHtml}
                </div>
                ${actionButtonsHtml}
                `;
            
            addCardEventListeners(itemCard, item);
            return itemCard;
        }

        function createItemTableRow(item) {
            const isPlaceholder = item.id.startsWith('placeholder-');
            
            const isInk = (majorCategoryMap[item.category] || '其他') === '墨水匣';
            const threshold = isInk ? CONSTANTS.INK_LOW_STOCK_THRESHOLD : CONSTANTS.OTHER_LOW_STOCK_THRESHOLD;
            const isLowStock = item.quantity < threshold && item.quantity > 0;
            const isZero = item.quantity === 0;

            let rowClasses = 'border-b transition-colors';
            if (isPlaceholder) {
                 rowClasses += ' bg-slate-50';
            }
            if (isZero) {
                rowClasses += ' bg-red-50 hover:bg-red-100';
            } else if (isLowStock) {
                 rowClasses += ' bg-amber-50 hover:bg-amber-100';
            }

            let nameCellContent = `<div>${item.name || 'N/A'}</div>`;
            if (isZero) {
                nameCellContent = `<div>
                    <div class="flex items-center font-bold text-red-800"><i data-lucide="shopping-cart" class="w-4 h-4 mr-2"></i><span>${item.name || 'N/A'}</span></div>
                    <div class="text-xs text-red-600 font-semibold mt-1">庫存已歸零 (建議庫存: ${threshold})</div>
                </div>`;
            } else if (isLowStock) {
                 nameCellContent += `<div class="text-xs text-amber-600 font-semibold flex items-center mt-1"><i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i>請盡快採購 (建議庫存: ${threshold})</div>`;
            }
            
            const actionButtonsCell = !isPlaceholder ? `
                <div class="flex items-center justify-center space-x-1">
                    <button data-action="unseal" class="btn-action bg-blue-100 text-blue-600 rounded-md h-7 px-3 flex items-center justify-center hover:bg-blue-200 text-xs font-semibold" ${item.quantity <= 0 ? 'disabled' : ''}>拆封</button>
                    <button data-action="decrease" class="btn-action bg-slate-100 text-slate-600 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-200 text-base font-bold" ${item.quantity <= 0 ? 'disabled' : ''}>-</button>
                    <button data-action="increase" class="btn-action bg-green-100 text-green-700 rounded-md w-7 h-7 flex items-center justify-center hover:bg-green-200 text-base font-bold">+</button>
                    <button data-action="edit" class="btn-action text-slate-500 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-200 hover:text-indigo-600"><i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i></button>
                    <button data-action="delete" class="btn-action text-slate-500 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-200 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            ` : `<span class="text-xs text-slate-400">尚未入庫</span>`;

            const historyText = `入庫: ${item.inboundHistory?.length || 0}次, 拆封: ${item.usageHistory?.length || 0}次`;

            return `
                <tr class="${rowClasses}" data-item-id="${item.id}">
                    <td class="px-4 py-3 font-medium text-slate-900">${nameCellContent}</td>
                    <td class="px-4 py-3">${item.purchaseNumber || 'N/A'}</td>
                    <td class="px-4 py-3">${item.lastPurchaseDate || '---'}</td>
                    <td class="px-4 py-3 text-xs">${historyText}</td>
                    <td class="px-4 py-3 text-center"><span data-role="quantity-display" class="font-bold text-base text-slate-800">${item.quantity}</span></td>
                    <td class="px-4 py-3 text-center">${actionButtonsCell}</td>
                </tr>`;
        }
        
        function renderUnsealHistory() {
            const historyList = DOM.unsealHistoryList;
            historyList.innerHTML = '';
            
            const allHistory = allSupplies
                .flatMap(item => (item.usageHistory || []).map(h => ({ name: item.name, category: item.category, date: h.unsealedDate })))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allHistory.length > 0) {
                DOM.unsealHistorySection.style.display = 'block';
                allHistory.slice(0, 15).forEach(entry => { // Show latest 15
                    const li = document.createElement('div');
                    li.className = 'text-sm text-slate-600 border-b border-slate-100 py-2 flex justify-between items-center';
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-slate-800">${entry.name}</span>
                            <span class="text-xs text-slate-400 ml-2">(${majorCategoryMap[entry.category] || '其他'})</span>
                        </div>
                        <span class="text-xs font-mono bg-slate-100 text-slate-500 px-2 py-0.5 rounded">${entry.date}</span>
                    `;
                    historyList.appendChild(li);
                });
            } else {
                DOM.unsealHistorySection.style.display = 'none';
            }
        }
        
        // --- Event Listener Helpers ---
        function setItemLoadingState(uniqueId, isLoading) {
            const elements = document.querySelectorAll(`[data-item-id="${uniqueId}"]`);
            elements.forEach(element => {
                if (isLoading) {
                    element.classList.add('opacity-50', 'pointer-events-none');
                    const quantityDisplay = element.querySelector('[data-role="quantity-display"]');
                    if (quantityDisplay) {
                        quantityDisplay.innerHTML = `<svg class="animate-spin h-5 w-5 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    }
                }
            });
        }

        function addCardEventListeners(card, item) {
            card.addEventListener('click', (e) => handleItemAction(e, item));
        }

        function addTableEventListeners(table) {
            table.addEventListener('click', (e) => {
                const row = e.target.closest('tr[data-item-id]');
                if (row) {
                    const itemId = row.dataset.itemId;
                    const item = allSupplies.find(s => s.id === itemId);
                    if (item) handleItemAction(e, item);
                }
            });
        }
        
        function handleItemAction(e, item) {
            const button = e.target.closest('button[data-action]');
            if (!button || button.disabled) return;
            const action = button.dataset.action;

            switch (action) {
                case 'increase':
                    openAddStockModal(item);
                    break;
                case 'decrease':
                    showConfirmation('確認出庫', `確定要將 "${item.name}" 的庫存減 1 嗎？`, () => unsealItem(item.id, item.quantity - 1, 'manual'), 'orange');
                    break;
                case 'delete':
                    showConfirmation('確認刪除', `您確定要永久刪除 "${item.name}" 這筆紀錄嗎？`, () => deleteItem(item.id), 'red');
                    break;
                case 'edit':
                    openEditModal(item);
                    break;
                case 'unseal':
                    showConfirmation('確認拆封', `確定要拆封一個 "${item.name}" 嗎？庫存將會減 1。`, () => unsealItem(item.id, item.quantity - 1, 'unseal'), 'blue');
                    break;
            }
        }
        
        // --- Modal & Confirmation Logic ---
        function openModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('opacity-0', '-translate-y-10');
            }, 10);
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('opacity-0', '-translate-y-10');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (modal === DOM.mappingsModal && editingKey) cancelEditMode();
                if (modal === DOM.addStockModal || modal === DOM.editItemModal) currentlyEditingItemId = null;
            }, 300);
        }

        function showConfirmation(title, message, onConfirm, type = 'red') {
            const modal = DOM.confirmationModal;
            const confirmBtn = modal.querySelector('#confirm-btn');
            const iconContainer = modal.querySelector('#confirmation-icon');
            
            const typeMap = {
                red: { btn: 'bg-red-600 hover:bg-red-700', icon: 'bg-red-100', iconContent: `<i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>` },
                blue: { btn: 'bg-blue-600 hover:bg-blue-700', icon: 'bg-blue-100', iconContent: `<i data-lucide="info" class="h-6 w-6 text-blue-600"></i>` },
                orange: { btn: 'bg-orange-500 hover:bg-orange-600', icon: 'bg-orange-100', iconContent: `<i data-lucide="alert-circle" class="h-6 w-6 text-orange-600"></i>` }
            };

            modal.querySelector('#confirmation-title').textContent = title;
            modal.querySelector('#confirmation-message').textContent = message;
            
            confirmBtn.className = `w-full text-white font-semibold py-2 px-4 rounded-lg transition-colors ${typeMap[type].btn}`;
            iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 ${typeMap[type].icon}`;
            iconContainer.innerHTML = typeMap[type].iconContent;
            lucide.createIcons();
            
            const newConfirmHandler = () => {
                onConfirm();
                closeModal(modal);
            };
            
            const newCancelHandler = () => {
                closeModal(modal);
            };

            const confirmBtnClone = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(confirmBtnClone, confirmBtn);
            confirmBtnClone.addEventListener('click', newConfirmHandler, { once: true });

            const cancelBtn = modal.querySelector('#cancel-confirmation-btn');
            const cancelBtnClone = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(cancelBtnClone, cancelBtn);
            cancelBtnClone.addEventListener('click', newCancelHandler, { once: true });
            
            openModal(modal);
        }

        // --- Mappings and Category Logic ---
        function initializeAndLoadMappings() {
            let mappings = JSON.parse(localStorage.getItem(CONSTANTS.MAPPINGS_KEY));
            if (!mappings || Object.keys(mappings).length === 0) { // Check if empty
                localStorage.setItem(CONSTANTS.MAPPINGS_KEY, JSON.stringify(initialPurchaseNumberMap));
                mappings = initialPurchaseNumberMap;
            }
            purchaseNumberMap = mappings;
            renderMappingsList();
            populateCategorySelects();
        }
        
        function renderMappingsList() {
            DOM.mappingsListContainer.innerHTML = '';
            
            const container = document.createElement('div');
            container.innerHTML = '<h4 class="font-semibold text-slate-700 mb-2">品項對照表</h4>';
            const list = document.createElement('div');
            list.className = 'space-y-2';

            const sortedKeys = Object.keys(purchaseNumberMap).sort();

            if (sortedKeys.length === 0) {
                list.innerHTML = '<p class="text-slate-500 text-sm">尚未建立任何品項。</p>';
            } else {
                sortedKeys.forEach(number => {
                    const item = purchaseNumberMap[number];
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm bg-slate-100 p-2 rounded-md';
                    div.innerHTML = `
                        <div>
                            <strong class="text-slate-800">${number}</strong>
                            <span class="text-slate-600 ml-2">${item.name} (${item.category})</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button data-key="${number}" class="edit-mapping-btn text-slate-500 hover:text-indigo-600" title="編輯">
                                <i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <button data-key="${number}" class="delete-mapping-btn text-slate-500 hover:text-red-600" title="刪除">
                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            container.appendChild(list);
            DOM.mappingsListContainer.appendChild(container);
            lucide.createIcons();
        }

        function startEditMode(key) {
            editingKey = key;
            const item = purchaseNumberMap[key];
            DOM.mappingFormTitle.textContent = '編輯對照品項';
            document.getElementById('new-purchase-number').value = key;
            document.getElementById('new-item-name').value = item.name;
            DOM.newItemCategorySelect.value = item.category;

            DOM.mappingFormButtons.innerHTML = `
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors btn-action">更新品項</button>
                <button type="button" id="cancel-edit-btn" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
            `;
            document.getElementById('cancel-edit-btn').addEventListener('click', cancelEditMode);
            DOM.addMappingForm.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditMode() {
            editingKey = null;
            DOM.addMappingForm.reset();
            DOM.mappingFormTitle.textContent = '新增對照品項';
            DOM.mappingFormButtons.innerHTML = `
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn-action">儲存品項</button>
            `;
        }

        function populateCategorySelects() {
            const allCategories = [...new Set(Object.values(purchaseNumberMap).map(item => item.category))];
            const customCategories = JSON.parse(localStorage.getItem(CONSTANTS.CUSTOM_CATEGORIES_KEY)) || [];
            const finalCategories = [...new Set([...allCategories, ...customCategories])].sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            
            const selects = [DOM.categorySelect, DOM.newItemCategorySelect];
            selects.forEach(select => {
                const currentVal = select.value;
                const placeholder = select.querySelector('option[disabled]');
                select.innerHTML = '';
                if(placeholder) select.appendChild(placeholder);
                
                finalCategories.forEach(categoryName => {
                    const option = document.createElement('option');
                    option.value = categoryName;
                    option.textContent = categoryName;
                    select.appendChild(option);
                });
                select.value = currentVal;
            });
        }

        function addCategoryOption(categoryName, selectAfterAdding = false) {
            if (!categoryName) return;

            const selects = [DOM.categorySelect, DOM.newItemCategorySelect];
            selects.forEach(select => {
                    if (!Array.from(select.options).some(opt => opt.value === categoryName)){
                        const option = document.createElement('option');
                        option.value = categoryName;
                        option.textContent = categoryName;
                        select.appendChild(option);
                    }
            });
            
            if (selectAfterAdding) {
                DOM.categorySelect.value = categoryName;
            }
        }

        function saveCustomCategory(categoryName) {
            let categories = JSON.parse(localStorage.getItem(CONSTANTS.CUSTOM_CATEGORIES_KEY)) || [];
            if (!categories.includes(categoryName)) {
                categories.push(categoryName);
                localStorage.setItem(CONSTANTS.CUSTOM_CATEGORIES_KEY, JSON.stringify(categories));
                populateCategorySelects();
            }
        }


        // --- Update/Delete/Edit Functions ---
        function unsealItem(id, newQuantity, type = 'unseal') {
            const item = allSupplies.find(s => s.id === id);
            if (!item) return;

            const today = new Date().toISOString().split('T')[0];
            const historyEntry = type === 'unseal' ? { unsealedDate: today, type: 'unseal' } : { unsealedDate: today, type: 'manual_decrease' };

            item.quantity = newQuantity;
            if(!item.usageHistory) item.usageHistory = [];
            item.usageHistory.push(historyEntry);

            saveData();
            renderInventory();
            renderUnsealHistory();
            showToast('庫存已更新');
        }

        function deleteItem(id) {
            allSupplies = allSupplies.filter(item => item.id !== id);
            saveData();
            renderInventory();
            renderUnsealHistory();
            showToast('項目已刪除');
        }
        
        function openAddStockModal(item) {
            currentlyEditingItemId = item.id;
            DOM.addStockForm.reset();
            DOM.addStockForm['add-stock-date'].value = new Date().toISOString().split('T')[0];
            openModal(DOM.addStockModal);
        }

        function openEditModal(item) {
            currentlyEditingItemId = item.id;
            DOM.editItemForm['edit-last-purchase-date'].value = item.lastPurchaseDate || '';
            DOM.editItemForm['edit-quantity'].value = item.quantity;
            openModal(DOM.editItemModal);
        }

        function setupAddStockFormListener() {
            DOM.addStockForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!currentlyEditingItemId) return;
                
                const date = DOM.addStockForm['add-stock-date'].value || new Date().toISOString().split('T')[0];
                const quantity = parseInt(DOM.addStockForm['add-stock-quantity'].value, 10);

                if (isNaN(quantity) || quantity <= 0) {
                    showToast('請輸入有效的數量', 'error');
                    return;
                }

                const item = allSupplies.find(s => s.id === currentlyEditingItemId);
                if (item) {
                    item.quantity += quantity;
                    item.lastPurchaseDate = date;
                    if (!item.inboundHistory) item.inboundHistory = [];
                    item.inboundHistory.push({ date, quantity, type: 'restock' });
                    
                    saveData();
                    renderInventory();
                    renderUnsealHistory();
                    closeModal(DOM.addStockModal);
                    showToast('入庫成功');
                }
            });
        }
        
        function setupEditFormListener() {
            DOM.editItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!currentlyEditingItemId) return;
                
                const newLastPurchaseDate = DOM.editItemForm['edit-last-purchase-date'].value;
                const newQuantity = parseInt(DOM.editItemForm['edit-quantity'].value, 10);

                if (isNaN(newQuantity)) {
                    showToast('請輸入有效的庫存數量', 'error');
                    return;
                }

                const item = allSupplies.find(s => s.id === currentlyEditingItemId);
                if (item) {
                    item.quantity = newQuantity;
                    item.lastPurchaseDate = newLastPurchaseDate;
                    if(item.inboundHistory && item.inboundHistory.length > 0) {
                         item.inboundHistory[item.inboundHistory.length - 1].date = newLastPurchaseDate;
                    }
                    
                    saveData();
                    renderInventory();
                    renderUnsealHistory();
                    closeModal(DOM.editItemModal);
                    showToast('庫存項目更新成功');
                }
            });
        }

        // --- View Toggler ---
        function setView(view) {
            currentView = view;
            localStorage.setItem(CONSTANTS.VIEW_MODE_KEY, view);
            const cardBtn = DOM.viewToggle.querySelector('[data-view="card"]');
            const tableBtn = DOM.viewToggle.querySelector('[data-view="table"]');
            
            cardBtn.classList.toggle('bg-white', view === 'card');
            cardBtn.classList.toggle('shadow-sm', view === 'card');
            cardBtn.classList.toggle('text-indigo-600', view === 'card');
            cardBtn.classList.toggle('text-slate-500', view !== 'card');
            
            tableBtn.classList.toggle('bg-white', view === 'table');
            tableBtn.classList.toggle('shadow-sm', view === 'table');
            tableBtn.classList.toggle('text-indigo-600', view === 'table');
            tableBtn.classList.toggle('text-slate-500', view !== 'table');
        }

        function downloadCSV() {
            const headers = [
                "採購編號", "耗材名稱", "品項", "庫存量", "最近入庫日期", 
                "入庫紀錄", "拆封紀錄"
            ];

            const sanitizeField = (field) => {
                const str = String(field || '').replace(/"/g, '""');
                return `"${str}"`;
            };

            const rows = allSupplies.map(item => {
                const inboundHistory = (item.inboundHistory || [])
                    .map(h => `${h.date}: ${h.quantity}件`)
                    .join('; ');
                const usageHistory = (item.usageHistory || [])
                    .map(h => h.unsealedDate)
                    .join('; ');
                
                return [
                    sanitizeField(item.purchaseNumber),
                    sanitizeField(item.name),
                    sanitizeField(item.category),
                    item.quantity,
                    sanitizeField(item.lastPurchaseDate),
                    sanitizeField(inboundHistory),
                    sanitizeField(usageHistory)
                ].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `庫存報表_${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('報表已開始下載');
        }

        // --- Main Initialization ---
        function main() {
            initializeAndLoadMappings();
            setView(currentView);
            lucide.createIcons();
            
            // --- EVENT LISTENERS ---
            DOM.viewToggle.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if(button) {
                    const view = button.dataset.view;
                    setView(view);
                    renderInventory();
                }
            });

            DOM.manageMappingsBtn.addEventListener('click', () => openModal(DOM.mappingsModal));
            DOM.closeMappingsModalBtn.addEventListener('click', () => closeModal(DOM.mappingsModal));
            DOM.mappingsModal.addEventListener('click', (e) => { if (e.target === DOM.mappingsModal) closeModal(DOM.mappingsModal); });
            
            DOM.closeAddStockModalBtn.addEventListener('click', () => closeModal(DOM.addStockModal));
            DOM.addStockModal.addEventListener('click', (e) => { if (e.target === DOM.addStockModal) closeModal(DOM.addStockModal); });

            DOM.closeEditModalBtn.addEventListener('click', () => closeModal(DOM.editItemModal));
            DOM.editItemModal.addEventListener('click', (e) => { if (e.target === DOM.editItemModal) closeModal(DOM.editItemModal); });
            
            DOM.addCategoryBtn.addEventListener('click', () => {
                const newCategory = prompt('請輸入新的耗材類別(品項)名稱：');
                if (newCategory && newCategory.trim() !== '') {
                    const trimmedCategory = newCategory.trim();
                    saveCustomCategory(trimmedCategory);
                    DOM.newItemCategorySelect.value = trimmedCategory;
                    showToast(`類別 "${trimmedCategory}" 已新增`);
                }
            });

            DOM.downloadCsvBtn.addEventListener('click', downloadCSV);

            DOM.purchaseNumberInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                const feedbackEl = DOM.purchaseNumberFeedback;
                const resultsContainer = DOM.purchaseNumberResults;

                resultsContainer.innerHTML = '';
                feedbackEl.textContent = '';
                
                if (!searchTerm) {
                    resultsContainer.classList.add('hidden');
                    return;
                }

                const results = Object.entries(purchaseNumberMap).filter(([key, value]) => {
                    return key.toLowerCase().includes(searchTerm) || value.name.toLowerCase().includes(searchTerm);
                });

                if (results.length > 0) {
                    results.forEach(([key, value]) => {
                        const resultEl = document.createElement('div');
                        resultEl.className = 'p-2 hover:bg-indigo-100 cursor-pointer';
                        resultEl.innerHTML = `<p class="font-semibold text-slate-800">${value.name}</p><p class="text-sm text-slate-500">${key}</p>`;
                        resultEl.dataset.key = key;
                        resultsContainer.appendChild(resultEl);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.classList.add('hidden');
                    feedbackEl.textContent = '查無編號，請新增';
                }
            });

            DOM.purchaseNumberResults.addEventListener('click', (e) => {
                const resultEl = e.target.closest('[data-key]');
                if (resultEl) {
                    const key = resultEl.dataset.key;
                    const item = purchaseNumberMap[key];
                    
                    DOM.purchaseNumberInput.value = key;
                    DOM.itemNameInput.value = item.name;
                    addCategoryOption(item.category, true);

                    DOM.purchaseNumberResults.classList.add('hidden');
                    DOM.purchaseNumberFeedback.textContent = '';
                }
            });

            document.addEventListener('click', (e) => {
                if (!DOM.purchaseNumberInput.contains(e.target) && !DOM.purchaseNumberResults.contains(e.target)) {
                    DOM.purchaseNumberResults.classList.add('hidden');
                }
            });

            DOM.addMappingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const number = document.getElementById('new-purchase-number').value.trim();
                const name = document.getElementById('new-item-name').value.trim();
                const category = DOM.newItemCategorySelect.value;
                if (!number || !name || !category) return;
                
                let mappings = JSON.parse(localStorage.getItem(CONSTANTS.MAPPINGS_KEY)) || {};

                if (editingKey && editingKey !== number) {
                    delete mappings[editingKey];
                }
                
                mappings[number] = { name, category };
                localStorage.setItem(CONSTANTS.MAPPINGS_KEY, JSON.stringify(mappings));
                
                if (editingKey) {
                    cancelEditMode();
                } else {
                    DOM.addMappingForm.reset();
                }
                
                initializeAndLoadMappings();
                showToast('品項儲存成功！');
            });

            DOM.mappingsListContainer.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-mapping-btn');
                const deleteButton = e.target.closest('.delete-mapping-btn');

                if (editButton) {
                    const key = editButton.dataset.key;
                    startEditMode(key);
                } else if (deleteButton) {
                    const key = deleteButton.dataset.key;
                        showConfirmation(
                            '確認刪除',
                            `您確定要刪除品項 "${key}" 嗎？此操作無法復原。`,
                            () => {
                                let mappings = JSON.parse(localStorage.getItem(CONSTANTS.MAPPINGS_KEY)) || {};
                                delete mappings[key];
                                localStorage.setItem(CONSTANTS.MAPPINGS_KEY, JSON.stringify(mappings));
                                initializeAndLoadMappings();
                                showToast('品項已刪除');
                            }
                        );
                }
            });

            loadData();
            setupFormListener();
            setupAddStockFormListener();
            setupEditFormListener();
        }

        main();
    </script>
</body>
</html>

